<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MM Courier Route Planner</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { margin:0; height:100vh; overflow:hidden; }
  #app { display:flex; flex-direction:column; height:100vh; }

  /* Fixed top bar */
  #topbar {
    height:56px;
    background:white;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
    display:flex;
    align-items:center;
    padding:0 12px;
    z-index:600;
  }

  #map {
    flex:1;
    width:100%;
  }

  #controls {
    background:white;
    padding:1rem;
    border-top:1px solid #e5e7eb;
    z-index:500;
  }

  #sidebar {
    position:fixed;
    top:0;
    left:0;
    width:280px;
    height:100vh;
    background:white;
    transform:translateX(-100%);
    transition:transform 0.3s ease;
    z-index:1000;
    overflow-y:auto;
    box-shadow:2px 0 6px rgba(0,0,0,0.2);
  }

  #sidebar.visible { transform:translateX(0); }
</style>
</head>

<body>
<div id="app">

  <!-- Sidebar -->
  <div id="sidebar" class="p-4">
    <h2 class="text-lg font-bold mb-3">üìç Stops</h2>
    <div id="stopList" class="space-y-2"></div>

    <div class="mt-4 border-t pt-4">
      <p class="text-sm font-semibold">Distance</p>
      <p id="totalDistance">‚Äî</p>
      <p class="text-sm font-semibold mt-2">Time</p>
      <p id="totalTime">‚Äî</p>
    </div>

    <button id="navBtn" class="mt-6 w-full bg-green-700 text-white py-2 rounded">
      Start Route
    </button>
  </div>

  <!-- Top Bar -->
  <div id="topbar">
    <button id="toggleSidebar"
      class="px-4 py-2 bg-gray-100 rounded font-semibold">
      ‚ò∞ Stops
    </button>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Controls -->
  <div id="controls">
    <input id="newAddress" type="text"
      placeholder="Enter address"
      class="border px-3 py-2 rounded w-full mb-2" />

    <ul id="suggestions"
      class="border bg-white rounded mb-2 max-h-40 overflow-y-auto hidden"></ul>

    <button id="addStop"
      class="w-full bg-blue-700 text-white py-2 rounded mb-2">
      Add Stop
    </button>

    <button id="loadRoute"
      class="w-full bg-green-700 text-white py-2 rounded">
      Optimize Route
    </button>
  </div>

</div>

<script>
const map = L.map("map").setView([-26.2041, 28.0473], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let stops = [];
let markers = [];
const maxStopsFree = 10;

// Sidebar toggle
const sidebar = document.getElementById("sidebar");
document.getElementById("toggleSidebar").onclick = () =>
  sidebar.classList.toggle("visible");

// Close sidebar when clicking outside
document.addEventListener("click", (e) => {
  if (!sidebar.contains(e.target) &&
      !document.getElementById("toggleSidebar").contains(e.target)) {
    sidebar.classList.remove("visible");
  }
});

// -------- Address autocomplete (OSM) ----------
const input = document.getElementById("newAddress");
const suggestionList = document.getElementById("suggestions");

input.addEventListener("input", async () => {
  const q = input.value;
  if (q.length < 3) {
    suggestionList.classList.add("hidden");
    return;
  }

  const res = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`
  );
  const data = await res.json();

  suggestionList.innerHTML = "";
  data.forEach(item => {
    const li = document.createElement("li");
    li.className = "p-2 hover:bg-gray-100 cursor-pointer";
    li.textContent = item.display_name;
    li.onclick = () => {
      input.value = item.display_name;
      input.dataset.lat = item.lat;
      input.dataset.lon = item.lon;
      suggestionList.classList.add("hidden");
    };
    suggestionList.appendChild(li);
  });

  suggestionList.classList.remove("hidden");
});

// -------- Add Stop ----------
document.getElementById("addStop").onclick = () => {
  if (!input.dataset.lat) return alert("Select an address");

  if (stops.length >= maxStopsFree)
    return alert("Free tier limited to 10 stops");

  const stop = {
    lat: +input.dataset.lat,
    lon: +input.dataset.lon,
    name: input.value,
    status: "pending"
  };

  stops.push(stop);
  markers.push(L.marker([stop.lat, stop.lon]).addTo(map));

  input.value = "";
  delete input.dataset.lat;
  updateStops();
};

// -------- Sidebar Stops ----------
function updateStops() {
  const list = document.getElementById("stopList");
  list.innerHTML = "";

  stops.forEach((s, i) => {
    const div = document.createElement("div");
    div.className = "border p-2 rounded space-y-1";

    div.innerHTML = `
      <div class="font-semibold">${i+1}. ${s.name}</div>
      <div class="flex gap-2">
        <button class="delivered bg-green-600 text-white px-2 py-1 rounded text-sm">Delivered</button>
        <button class="notdelivered bg-red-600 text-white px-2 py-1 rounded text-sm">Not Delivered</button>
      </div>
    `;

    div.querySelector(".delivered").onclick = () => {
      s.status = "delivered";
      div.classList.add("bg-green-50");
    };

    div.querySelector(".notdelivered