<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MM Courier Route Planner</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { margin:0; height:100vh; overflow:hidden; }
  #app { display:flex; flex-direction:column; height:100vh; }

  /* Top bar */
  #topbar {
    height:56px;
    background:white;
    display:flex;
    align-items:center;
    padding:0 12px;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
    z-index:600;
  }

  /* Map ONLY */
  #map {
    flex:1;
    width:100%;
  }

  /* Address panel */
  #controls {
    background:white;
    padding:12px;
    border-top:1px solid #e5e7eb;
  }

  /* Action bar (buttons you couldn‚Äôt reach) */
  #actionBar {
    background:white;
    padding:12px;
    border-top:1px solid #e5e7eb;
    display:flex;
    gap:8px;
  }

  /* Sidebar */
  #sidebar {
    position:fixed;
    top:0;
    left:0;
    width:280px;
    height:100vh;
    background:white;
    transform:translateX(-100%);
    transition:transform 0.3s ease;
    z-index:1000;
    overflow-y:auto;
    box-shadow:2px 0 6px rgba(0,0,0,0.2);
  }

  #sidebar.visible { transform:translateX(0); }
</style>
</head>

<body>
<div id="app">

  <!-- Sidebar -->
  <div id="sidebar" class="p-4">
    <h2 class="text-lg font-bold mb-3">üìç Stops</h2>
    <div id="stopList" class="space-y-2"></div>
  </div>

  <!-- Top Bar -->
  <div id="topbar">
    <button id="toggleSidebar"
      class="px-4 py-2 bg-gray-100 rounded font-semibold">
      ‚ò∞ Stops
    </button>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Address Controls -->
  <div id="controls">
    <input id="newAddress" type="text"
      placeholder="Enter address"
      class="border px-3 py-2 rounded w-full mb-2" />

    <ul id="suggestions"
      class="border bg-white rounded mb-2 max-h-40 overflow-y-auto hidden"></ul>

    <button id="addStop"
      class="w-full bg-blue-700 text-white py-2 rounded">
      Add Stop
    </button>
  </div>

  <!-- Action Bar (FIXED & CLICKABLE) -->
  <div id="actionBar">
    <button id="loadRoute"
      class="flex-1 bg-green-700 text-white py-2 rounded">
      Optimize Route
    </button>

    <button id="startRoute"
      class="flex-1 bg-indigo-700 text-white py-2 rounded">
      Start Route
    </button>
  </div>

</div>

<script>
/* ---------- MAP ---------- */
const map = L.map("map").setView([-26.2041, 28.0473], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let stops = [];
let markers = [];
let routeLine;

/* ---------- SIDEBAR ---------- */
const sidebar = document.getElementById("sidebar");
document.getElementById("toggleSidebar").onclick = () =>
  sidebar.classList.toggle("visible");

document.addEventListener("click", (e) => {
  if (!sidebar.contains(e.target) &&
      !document.getElementById("toggleSidebar").contains(e.target)) {
    sidebar.classList.remove("visible");
  }
});

/* ---------- AUTOCOMPLETE ---------- */
const input = document.getElementById("newAddress");
const suggestionList = document.getElementById("suggestions");

input.addEventListener("input", async () => {
  const q = input.value.trim();
  if (q.length < 3) {
    suggestionList.classList.add("hidden");
    return;
  }

  const res = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`
  );
  const data = await res.json();

  suggestionList.innerHTML = "";
  data.forEach(item => {
    const li = document.createElement("li");
    li.className = "p-2 hover:bg-gray-100 cursor-pointer";
    li.textContent = item.display_name;
    li.onclick = () => {
      input.value = item.display_name;
      input.dataset.lat = item.lat;
      input.dataset.lon = item.lon;
      suggestionList.classList.add("hidden");
    };
    suggestionList.appendChild(li);
  });

  suggestionList.classList.remove("hidden");
});

/* ---------- ADD STOP ---------- */
document.getElementById("addStop").onclick = () => {
  if (!input.dataset.lat) return alert("Select address");

  const stop = {
    lat:+input.dataset.lat,
    lon:+input.dataset.lon,
    name:input.value
  };

  stops.push(stop);
  markers.push(L.marker([stop.lat, stop.lon]).addTo(map));
  map.setView([stop.lat, stop.lon], 14);

  input.value = "";
  delete input.dataset.lat;
  suggestionList.classList.add("hidden");
  updateStops();
};

/* ---------- UPDATE STOPS ---------- */
function updateStops(){
  const list = document.getElementById("stopList");
  list.innerHTML = "";
  stops.forEach((s,i)=>{
    const div = document.createElement("div");
    div.className="border p-2 rounded";
    div.textContent = `${i+1}. ${s.name}`;
    div.onclick = ()=>map.setView([s.lat,s.lon],15);
    list.appendChild(div);
  });
}

/* ---------- OPTIMIZE (Simple NN) ---------- */
document.getElementById("loadRoute").onclick = () => {
  if (stops.length < 2) return alert("Add at least 2 stops");

  const ordered=[stops[0]];
  const rest=stops.slice(1);

  while(rest.length){
    const last=ordered.at(-1);
    let idx=0,min=dist(last,rest[0]);
    for(let i=1;i<rest.length;i++){
      const d=dist(last,rest[i]);
      if(d<min){min=d;idx=i;}
    }
    ordered.push(rest[idx]);
    rest.splice(idx,1);
  }

  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(ordered.map(s=>[s.lat,s.lon]),{color:"blue"}).addTo(map);
  map.fitBounds(routeLine.getBounds());

  stops=ordered;
  updateStops();
};

function dist(a,b){
  const dx=(b.lon-a.lon)*Math.cos((a.lat+b.lat)/2*Math.PI/180);
  const dy=b.lat-a.lat;
  return Math.sqrt(dx*dx+dy*dy);
}

/* ---------- START ROUTE (in-app ready) ---------- */
document.getElementById("startRoute").onclick = () => {
  if (!routeLine) return alert("Optimize first");
  alert("Next step: live in-app navigation");
};
</script>
</body>
</html>