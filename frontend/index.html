<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
<title>MM Courier Route Planner</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Places -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPXDWN4D1063Yzml3zGjwb36ewDwzkVuk&libraries=places&callback=initAutocomplete" defer></script>

<style>
body { overflow: hidden; }
#map { height: 100vh; width: 100%; }

#sidebar {
  transition: transform .3s;
  z-index: 2000;
}
.sidebar-hidden { transform: translateX(-100%); }
.sidebar-visible { transform: translateX(0); }

#bottomPanel {
  z-index: 1500;
}

.pac-container { z-index: 3000 !important; }
</style>
</head>

<body class="bg-gray-100">

<!-- SIDEBAR -->
<div id="sidebar" class="fixed top-0 left-0 w-72 h-screen bg-white shadow-xl p-4 sidebar-hidden overflow-y-auto">
  <h2 class="font-bold text-lg mb-2">üìç Stops</h2>
  <div id="stopList" class="space-y-2"></div>

  <div class="mt-4 border-t pt-2 text-sm">
    <div>Distance: <span id="totalDistance">‚Äî</span></div>
    <div>Time: <span id="totalTime">‚Äî</span></div>
  </div>

  <button id="startRoute" class="mt-4 w-full bg-green-700 text-white py-2 rounded">
    Start Route
  </button>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- TOP BUTTON -->
<button id="toggleSidebar"
  class="fixed top-4 left-4 bg-white shadow px-4 py-2 rounded z-[2500]">
  ‚ò∞ Stops
</button>

<!-- BOTTOM PANEL -->
<div id="bottomPanel"
  class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-white p-4 rounded shadow w-[95%] max-w-md">

  <input id="addressInput" type="text" placeholder="Enter address"
    class="border p-2 rounded w-full mb-2"/>

  <button id="addStop"
    class="w-full bg-blue-700 text-white py-2 rounded mb-2">
    Add Stop
  </button>

  <button id="optimizeRoute"
    class="w-full bg-indigo-700 text-white py-2 rounded mb-2">
    Optimize Route
  </button>

  <!-- NAV MODE -->
  <div id="navPanel" class="hidden mt-2 border-t pt-2 text-sm">
    <div class="font-semibold text-blue-800">Current Stop</div>
    <div id="currentStopName" class="mt-1"></div>
    <div class="mt-1">Distance: <span id="distanceToStop">‚Äî</span></div>

    <div class="flex gap-2 mt-2">
      <button id="deliveredBtn" class="flex-1 bg-green-700 text-white py-2 rounded">
        Delivered
      </button>
      <button id="failedBtn" class="flex-1 bg-red-600 text-white py-2 rounded">
        Not Delivered
      </button>
    </div>
  </div>
</div>

<script>
/* ---------------- SETUP ---------------- */
const API_URL = "https://mm-courier-route-planner.onrender.com";

const map = L.map("map").setView([-26.2041, 28.0473], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let autocomplete;
let stops = [];
let markers = [];
let routeLine;
let currentStopIndex = null;
let gpsWatchId = null;
let userMarker;

/* ---------------- AUTOCOMPLETE ---------------- */
function initAutocomplete() {
  autocomplete = new google.maps.places.Autocomplete(
    document.getElementById("addressInput")
  );
}

/* ---------------- ADD STOP ---------------- */
document.getElementById("addStop").onclick = () => {
  const place = autocomplete.getPlace();
  if (!place?.geometry) return alert("Select address from list");

  const stop = {
    lat: place.geometry.location.lat(),
    lon: place.geometry.location.lng(),
    name: place.formatted_address,
    status: "pending"
  };

  stops.push(stop);
  markers.push(L.marker([stop.lat, stop.lon]).addTo(map));
  updateStopsUI();
  document.getElementById("addressInput").value = "";
};

/* ---------------- STOPS LIST ---------------- */
function updateStopsUI() {
  const list = document.getElementById("stopList");
  list.innerHTML = "";

  stops.forEach((s, i) => {
    const div = document.createElement("div");
    div.className = "p-2 border rounded text-sm";
    div.innerHTML = `
      <div class="font-semibold">${i+1}. ${s.name}</div>
      <div class="text-xs ${
        s.status === "delivered" ? "text-green-600"
        : s.status === "failed" ? "text-red-600"
        : "text-gray-400"
      }">${s.status}</div>
    `;
    div.onclick = () => map.setView([s.lat, s.lon], 15);
    list.appendChild(div);
  });
}

/* ---------------- OPTIMIZE ROUTE ---------------- */
document.getElementById("optimizeRoute").onclick = async () => {
  if (stops.length < 2) return alert("Add at least 2 stops");

  const res = await fetch(`${API_URL}/optimize`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ stops })
  });

  const data = await res.json();
  const route = data.routes?.[0];
  if (!route) return alert("Route failed");

  const coords = decodePolyline(route.overview_polyline.points);
  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline(coords, { color: "blue" }).addTo(map);
  map.fitBounds(routeLine.getBounds());

  document.getElementById("totalDistance").innerText =
    (route.legs.reduce((a,b)=>a+b.distance.value,0)/1000).toFixed(1)+" km";

  document.getElementById("totalTime").innerText =
    Math.round(route.legs.reduce((a,b)=>a+b.duration.value,0)/60)+" mins";
};

/* ---------------- START ROUTE ---------------- */
document.getElementById("startRoute").onclick = () => {
  currentStopIndex = 0;
  document.getElementById("navPanel").classList.remove("hidden");
  startGPS();
  updateNavUI();
};

/* ---------------- GPS ---------------- */
function startGPS() {
  gpsWatchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    if (!userMarker) {
      userMarker = L.circleMarker([lat, lon], { radius: 8, color: "blue" }).addTo(map);
    } else {
      userMarker.setLatLng([lat, lon]);
    }

    updateDistance(lat, lon);
  }, null, { enableHighAccuracy: true });
}

/* ---------------- NAV UI ---------------- */
function updateNavUI() {
  const stop = stops[currentStopIndex];
  document.getElementById("currentStopName").innerText = stop.name;
  updateStopsUI();
}

function updateDistance(lat, lon) {
  const stop = stops[currentStopIndex];
  const d = distanceMeters({lat,lon}, stop);
  document.getElementById("distanceToStop").innerText =
    d < 1000 ? Math.round(d)+" m" : (d/1000).toFixed(1)+" km";
}

/* ---------------- DELIVERY ---------------- */
document.getElementById("deliveredBtn").onclick = () => markStop("delivered");
document.getElementById("failedBtn").onclick = () => markStop("failed");

function markStop(status) {
  stops[currentStopIndex].status = status;
  currentStopIndex++;

  if (currentStopIndex >= stops.length) {
    alert("Route completed");
    navigator.geolocation.clearWatch(gpsWatchId);
    return;
  }
  updateNavUI();
}

/* ---------------- UI ---------------- */
document.getElementById("toggleSidebar").onclick = () => {
  sidebar.classList.toggle("sidebar-hidden");
  sidebar.classList.toggle("sidebar-visible");
};

/* ---------------- HELPERS ---------------- */
function distanceMeters(a,b){
  const R=6371e3;
  const dLat=(b.lat-a.lat)*Math.PI/180;
  const dLon=(b.lon-a.lon)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function decodePolyline(str){
  let i=0,lat=0,lng=0,arr=[];
  while(i<str.length){
    let b,s=0,r=0;
    do{b=str.charCodeAt(i++)-63;r|=(b&31)<<s;s+=5;}while(b>=32);
    lat+=r&1?~(r>>1):r>>1;
    s=0;r=0;
    do{b=str.charCodeAt(i++)-63;r|=(b&31)<<s;s+=5;}while(b>=32);
    lng+=r&1?~(r>>1):r>>1;
    arr.push([lat/1e5,lng/1e5]);
  }
  return arr;
}
</script>
</body>
</html>