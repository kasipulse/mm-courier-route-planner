<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MM Courier In-App Navigator</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body { height: 100%; margin:0; }
    #map { height: 100%; width: 100%; }
    #bottomPanel {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    #stopList { max-height: 200px; overflow-y: auto; margin-bottom: 0.5rem; }
    .pac-container { z-index: 2000 !important; }
  </style>
</head>
<body>

<div id="map"></div>

<div id="bottomPanel">
  <input id="newAddress" type="text" placeholder="Enter address" class="border px-3 py-2 rounded w-full mb-2">
  <button id="addStop" class="w-full bg-blue-700 text-white py-2 rounded mb-2 font-semibold">Add Stop</button>

  <div id="stopList" class="space-y-1"></div>

  <button id="startRoute" class="w-full bg-green-700 text-white py-2 rounded mb-2 font-semibold">Start Route</button>
  <button id="nextStop" class="w-full bg-yellow-500 text-white py-2 rounded mb-2 font-semibold" disabled>Next Stop</button>

  <div class="flex gap-2 mt-2">
    <button id="deliveredBtn" class="flex-1 bg-green-600 text-white py-2 rounded font-semibold" disabled>Delivered</button>
    <button id="notDeliveredBtn" class="flex-1 bg-red-600 text-white py-2 rounded font-semibold" disabled>Not Delivered</button>
  </div>
</div>

<script>
  let map = L.map('map').setView([-26.2041, 28.0473], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let stops = [];
  let markers = [];
  let currentStopIndex = 0;
  let routingControl = null;

  // Google Places Autocomplete
  let autocomplete;
  function initAutocomplete() {
    autocomplete = new google.maps.places.Autocomplete(document.getElementById("newAddress"), { types: ["geocode"] });
  }
  // Load Google Places
  const gmapScript = document.createElement('script');
  gmapScript.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCPXDWN4D1063Yzml3zGjwb36ewDwzkVuk&libraries=places&callback=initAutocomplete`;
  gmapScript.async = true; document.head.appendChild(gmapScript);

  // Add Stop
  document.getElementById('addStop').onclick = () => {
    const place = autocomplete.getPlace();
    if(!place || !place.geometry) return alert('Select a valid address');
    const lat = place.geometry.location.lat();
    const lon = place.geometry.location.lng();
    const name = place.formatted_address;

    stops.push({lat, lon, name});
    addMarker(lat, lon, name);
    updateStopList();
    document.getElementById('newAddress').value = '';
  };

  function addMarker(lat, lon, name) {
    const marker = L.marker([lat, lon]).addTo(map).bindPopup(name);
    markers.push(marker);
  }

  function updateStopList() {
    const list = document.getElementById('stopList');
    list.innerHTML = '';
    stops.forEach((s, i) => {
      const div = document.createElement('div');
      div.className = "p-1 border rounded flex justify-between items-center text-sm";
      div.innerHTML = `<span>${i+1}. ${s.name}</span><button class="text-red-600 font-bold">X</button>`;
      div.querySelector('button').onclick = e => {
        e.stopPropagation();
        stops.splice(i,1);
        map.removeLayer(markers[i]);
        markers.splice(i,1);
        updateStopList();
      };
      list.appendChild(div);
    });
  }

  // Start Route
  document.getElementById('startRoute').onclick = () => {
    if(stops.length < 2) return alert('Add at least 2 stops');
    currentStopIndex = 0;
    drawRoute();
    enableNavigationButtons();
  };

  function drawRoute() {
    if(routingControl) map.removeControl(routingControl);
    const waypoints = stops.map(s => L.latLng(s.lat,s.lon));
    routingControl = L.Routing.control({
      waypoints: waypoints,
      routeWhileDragging: false,
      show: false,
      addWaypoints: false,
      lineOptions: { styles: [{color:'blue', weight:4}] },
    }).addTo(map);
  }

  function enableNavigationButtons() {
    document.getElementById('nextStop').disabled = false;
    document.getElementById('deliveredBtn').disabled = false;
    document.getElementById('notDeliveredBtn').disabled = false;
  }

  // Next Stop
  document.getElementById('nextStop').onclick = () => {
    if(currentStopIndex < stops.length - 1) {
      currentStopIndex++;
      map.setView([stops[currentStopIndex].lat, stops[currentStopIndex].lon], 16);
      markers[currentStopIndex].openPopup();
    } else {
      alert('Route complete!');
    }
  };

  // Delivered / Not Delivered
  document.getElementById('deliveredBtn').onclick = () => {
    alert(`Stop ${currentStopIndex+1} delivered!`);
    // optionally mark visually
    markers[currentStopIndex].setIcon(new L.Icon.Default({className:'leaflet-div-icon delivered'}));
  };
  document.getElementById('notDeliveredBtn').onclick = () => {
    alert(`Stop ${currentStopIndex+1} not delivered!`);
  };
</script>

</body>
</html>