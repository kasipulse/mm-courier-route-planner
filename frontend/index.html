<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>MM Courier Route Planner</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Places API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPXDWN4D1063Yzml3zGjwb36ewDwzkVuk&libraries=places&callback=initAutocomplete"
    defer></script>

  <style>
    html, body { height: 100%; margin: 0; }
    body { -webkit-tap-highlight-color: transparent; }
    #map { height: 100%; width: 100%; }

    /* Sidebar */
    #sidebar {
      width: 260px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      overflow-y: auto;
      transform: translateX(-100%);
      transition: transform 0.3s;
      z-index: 1001;
      padding: 1rem;
    }
    #sidebar.sidebar-visible { transform: translateX(0); }

    /* Bottom panel */
    #bottomControls {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1002;
    }

    /* Google autocomplete dropdown */
    .pac-container { z-index: 2000 !important; }

    /* Stop buttons */
    .stop-button { margin-top: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.85rem; border-radius: 0.25rem; }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <h2 class="text-lg font-bold mb-4 text-blue-800">üìç Stops</h2>
    <div id="stopList" class="space-y-2"></div>

    <div class="mt-4 border-t pt-4">
      <p class="text-sm font-semibold">Total Distance:</p>
      <p id="totalDistance" class="text-lg text-blue-700">‚Äî</p>
      <p class="text-sm font-semibold mt-2">Estimated Time:</p>
      <p id="totalTime" class="text-lg text-blue-700">‚Äî</p>
    </div>

    <button id="navBtn" class="mt-4 w-full bg-green-700 text-white py-2 rounded-lg font-semibold">
      Start Route
    </button>

    <div id="navigationControls" class="mt-4 hidden">
      <div class="flex gap-2">
        <button id="deliveredBtn" class="bg-blue-600 text-white stop-button">Delivered</button>
        <button id="notDeliveredBtn" class="bg-red-600 text-white stop-button">Not Delivered</button>
      </div>
      <button id="nextStopBtn" class="mt-2 w-full bg-yellow-600 text-white py-1 rounded">Next Stop</button>
    </div>
  </div>

  <!-- Sidebar Toggle -->
  <button id="toggleSidebar" class="absolute top-4 left-4 z-1003 bg-white shadow px-4 py-2 rounded-lg font-semibold">
    ‚ò∞ Stops
  </button>

  <!-- Map -->
  <div id="map"></div>

  <!-- Bottom Controls -->
  <div id="bottomControls">
    <input id="newAddress" type="text" placeholder="Enter address"
      class="border px-3 py-2 rounded w-full mb-2" />
    <button id="addStop" class="w-full bg-blue-700 text-white py-2 rounded-lg mb-2 font-semibold">
      Add Stop
    </button>
    <button id="loadRoute" class="w-full bg-green-700 text-white py-2 rounded-lg font-semibold">
      Optimize Route
    </button>
  </div>

  <script>
    const API_URL = "https://mm-courier-route-planner.onrender.com";

    const map = L.map("map").setView([-26.2041, 28.0473], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    let stops = [];
    let markers = [];
    let routeLine = null;
    let currentStopIndex = 0;
    let autocomplete;

    function initAutocomplete() {
      autocomplete = new google.maps.places.Autocomplete(document.getElementById("newAddress"), { types: ["geocode"] });
    }

    // -------------------------
    // Sidebar toggle
    // -------------------------
    const toggleBtn = document.getElementById("toggleSidebar");
    const sidebar = document.getElementById("sidebar");
    toggleBtn.onclick = () => sidebar.classList.toggle("sidebar-visible");

    // -------------------------
    // Add Stop
    // -------------------------
    document.getElementById("addStop").onclick = () => {
      const place = autocomplete.getPlace();
      if (!place?.geometry) return alert("Select a valid address.");

      const lat = place.geometry.location.lat();
      const lon = place.geometry.location.lng();
      stops.push({ lat, lon, address: place.formatted_address });
      addMarker(lat, lon);
      updateSidebar();
      document.getElementById("newAddress").value = "";
    };

    function addMarker(lat, lon) {
      const marker = L.marker([lat, lon]).addTo(map);
      markers.push(marker);
    }

    // -------------------------
    // Update Sidebar
    // -------------------------
    function updateSidebar() {
      const list = document.getElementById("stopList");
      list.innerHTML = "";
      stops.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "p-2 border rounded flex justify-between items-center";

        div.innerHTML = `
          <div>
            <span class="font-semibold">Stop ${i+1}:</span> ${s.address || ""}
          </div>
          <button class="text-red-600 font-bold">X</button>
        `;
        div.onclick = () => map.setView([s.lat, s.lon], 14);
        div.querySelector("button").onclick = (e) => {
          e.stopPropagation();
          stops.splice(i,1);
          map.removeLayer(markers[i]);
          markers.splice(i,1);
          updateSidebar();
        };
        list.appendChild(div);
      });
    }

    // -------------------------
    // Optimize Route
    // -------------------------
    document.getElementById("loadRoute").onclick = async () => {
      if (stops.length < 2) return alert("Add at least 2 stops");

      const res = await fetch(`${API_URL}/optimize`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ stops })
      });
      const data = await res.json();
      if (!data.routes?.length) return alert("Route not found");

      const route = data.routes[0];
      const coords = decodePolyline(route.overview_polyline.points);

      if (routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords, { color: "blue" }).addTo(map);
      map.fitBounds(routeLine.getBounds());

      document.getElementById("totalDistance").innerText =
        route.legs.reduce((a,b)=>a+b.distance.value,0)/1000 + " km";
      document.getElementById("totalTime").innerText =
        Math.round(route.legs.reduce((a,b)=>a+b.duration.value,0)/60) + " mins";
    };

    // -------------------------
    // Start Route Navigation
    // -------------------------
    const navControls = document.getElementById("navigationControls");
    document.getElementById("navBtn").onclick = () => {
      if (!stops.length) return alert("Add stops first");
      currentStopIndex = 0;
      showStopControls();
      goToStop(currentStopIndex);
    };

    function showStopControls() { navControls.classList.remove("hidden"); }

    function goToStop(index) {
      const s = stops[index];
      if (!s) return alert("Route finished");
      map.setView([s.lat, s.lon], 16);
    }

    document.getElementById("nextStopBtn").onclick = () => {
      currentStopIndex++;
      if (currentStopIndex >= stops.length) {
        alert("Route completed!");
        navControls.classList.add("hidden");
        return;
      }
      goToStop(currentStopIndex);
    };

    document.getElementById("deliveredBtn").onclick = () => {
      alert(`Stop ${currentStopIndex+1} marked as Delivered`);
      goToStop(currentStopIndex); // stay on current until next pressed
    };

    document.getElementById("notDeliveredBtn").onclick = () => {
      alert(`Stop ${currentStopIndex+1} marked as Not Delivered`);
      goToStop(currentStopIndex); // stay on current until next pressed
    };

    // -------------------------
    // Polyline decoder
    // -------------------------
    function decodePolyline(str, precision=5){
      let index=0, lat=0, lng=0, coordinates=[], factor=Math.pow(10, precision);
      while(index < str.length){
        let result=0, shift=0, byte;
        do { byte = str.charCodeAt(index++) - 63; result |= (byte & 0x1f) << shift; shift += 5; } while(byte >= 0x20);
        const dLat = (result & 1 ? ~(result >> 1) : (result >> 1));
        lat += dLat;
        result=0; shift=0;
        do { byte = str.charCodeAt(index++) - 63; result |= (byte & 0x1f) << shift; shift +=5;} while(byte >=0x20);
        const dLng = (result &1 ? ~(result>>1) : (result>>1));
        lng += dLng;
        coordinates.push([lat/factor, lng/factor]);
      }
      return coordinates;
    }
  </script>
</body>
</html>