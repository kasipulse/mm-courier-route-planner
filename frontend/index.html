<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MM Courier Route Planner</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase AUTH GUARD -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // üîí Protect page
  onAuthStateChanged(auth, user => {
    if (!user) window.location.href = "/login.html";
  });

  // Logout
  window.logout = async () => {
    await signOut(auth);
    window.location.href = "/login.html";
  };
</script>

<style>
body { margin:0; height:100vh; overflow:hidden; font-family:sans-serif; }
#app { display:flex; flex-direction:column; height:100vh; }

/* Top bar */
#topbar {
  height:56px;
  background:white;
  display:flex;
  align-items:center;
  padding:0 12px;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
  position:fixed;
  top:0; left:0; right:0;
  z-index:50;
}

/* Sidebar */
#sidebar {
  position:fixed;
  top:56px;
  left:0;
  width:300px;
  height:calc(100vh - 56px);
  background:white;
  transform:translateX(-100%);
  transition:transform 0.3s ease;
  z-index:60;
  overflow-y:auto;
  box-shadow:2px 0 6px rgba(0,0,0,0.2);
}
#sidebar.visible { transform:translateX(0); }

.active-stop {
  border:2px solid #2563eb;
  background:#eff6ff;
}

/* Map */
#map { flex:1; margin-top:56px; }

/* Bottom controls */
#controls {
  background:white;
  padding:1rem;
  border-top:1px solid #e5e7eb;
}
</style>
</head>

<body>
<div id="app">

  <!-- Sidebar -->
  <div id="sidebar" class="p-4">
    <h2 class="text-lg font-bold mb-2">üìç Stops</h2>
    <p id="progress" class="text-sm mb-3">0 / 0 completed</p>
    <div id="stopList" class="space-y-2"></div>
  </div>

  <!-- Top bar -->
  <div id="topbar">
    <button id="toggleSidebar"
      class="px-4 py-2 bg-gray-100 rounded font-semibold">
      ‚ò∞ Stops
    </button>

    <div class="ml-auto">
      <button onclick="logout()"
        class="px-3 py-2 bg-red-600 text-white rounded text-sm">
        Logout
      </button>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Controls -->
  <div id="controls">
    <input id="newAddress" type="text"
      placeholder="Enter address"
      class="border px-3 py-2 rounded w-full mb-2" />

    <ul id="suggestions"
      class="border bg-white rounded mb-2 max-h-40 overflow-y-auto hidden"></ul>

    <button id="addStop"
      class="w-full bg-blue-700 text-white py-2 rounded mb-2">
      Add Stop
    </button>

    <button id="loadRoute"
      class="w-full bg-green-700 text-white py-2 rounded mb-2">
      Optimize Route
    </button>

    <button id="startRoute"
      class="w-full bg-indigo-700 text-white py-2 rounded">
      Start Route
    </button>
  </div>

</div>

<script>
/* ---------- MAP ---------- */
const map = L.map("map").setView([-26.2041, 28.0473], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ---------- STATE ---------- */
let stops = JSON.parse(localStorage.getItem("stops") || "[]");
let markers = [];
let activeIndex = 0;
const maxStopsFree = 10;

/* ---------- SIDEBAR ---------- */
const sidebar = document.getElementById("sidebar");
document.getElementById("toggleSidebar").onclick = () =>
  sidebar.classList.toggle("visible");

document.addEventListener("click", e => {
  if (!sidebar.contains(e.target) &&
      !document.getElementById("toggleSidebar").contains(e.target)) {
    sidebar.classList.remove("visible");
  }
});

/* ---------- AUTOCOMPLETE ---------- */
const input = document.getElementById("newAddress");
const suggestions = document.getElementById("suggestions");

input.addEventListener("input", async () => {
  if (input.value.length < 3) {
    suggestions.classList.add("hidden");
    return;
  }

  const res = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input.value)}&limit=5`
  );
  const data = await res.json();

  suggestions.innerHTML = "";
  data.forEach(item => {
    const li = document.createElement("li");
    li.className = "p-2 hover:bg-gray-100 cursor-pointer";
    li.textContent = item.display_name;
    li.onclick = () => {
      input.value = item.display_name;
      input.dataset.lat = item.lat;
      input.dataset.lon = item.lon;
      suggestions.classList.add("hidden");
    };
    suggestions.appendChild(li);
  });

  suggestions.classList.remove("hidden");
});

/* ---------- ADD STOP ---------- */
document.getElementById("addStop").onclick = () => {
  if (!input.dataset.lat) return alert("Select an address");
  if (stops.length >= maxStopsFree)
    return alert("Free tier max 10 stops");

  stops.push({
    name: input.value,
    lat: +input.dataset.lat,
    lon: +input.dataset.lon,
    status: "pending"
  });

  localStorage.setItem("stops", JSON.stringify(stops));
  input.value = "";
  delete input.dataset.lat;

  render();
};

/* ---------- RENDER ---------- */
function render() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  stops.forEach(s => {
    markers.push(L.marker([s.lat, s.lon]).addTo(map));
  });

  updateStopsUI();
}

/* ---------- STOPS UI ---------- */
function updateStopsUI() {
  const list = document.getElementById("stopList");
  list.innerHTML = "";
  let completed = 0;

  stops.forEach((s,i) => {
    if (s.status !== "pending") completed++;

    const div = document.createElement("div");
    div.className = "border p-2 rounded space-y-2";
    if (i === activeIndex && s.status === "pending")
      div.classList.add("active-stop");

    div.innerHTML = `
      <div class="font-semibold">${i+1}. ${s.name}</div>
      <div class="flex gap-2">
        <button class="deliver bg-green-600 text-white px-2 py-1 rounded text-sm">Delivered</button>
        <button class="fail bg-red-600 text-white px-2 py-1 rounded text-sm">Not Delivered</button>
      </div>
    `;

    div.querySelector(".deliver").onclick = () => markStop(i,"delivered");
    div.querySelector(".fail").onclick = () => markStop(i,"failed");

    list.appendChild(div);
  });

  document.getElementById("progress").textContent =
    `${completed} / ${stops.length} completed`;
}

/* ---------- MARK STOP ---------- */
function markStop(index,status) {
  stops[index].status = status;
  localStorage.setItem("stops", JSON.stringify(stops));
  moveToNext();
  render();
}

/* ---------- AUTO NEXT ---------- */
function moveToNext() {
  for (let i=0;i<stops.length;i++) {
    if (stops[i].status === "pending") {
      activeIndex = i;
      map.setView([stops[i].lat,stops[i].lon],15);
      return;
    }
  }
  alert("Route complete üéâ");
}

/* ---------- OPTIMIZE ---------- */
document.getElementById("loadRoute").onclick = () => {
  if (stops.length < 2) return;

  const ordered=[stops[0]];
  const rest=stops.slice(1);

  while(rest.length){
    const last=ordered.at(-1);
    let idx=0, best=dist(last,rest[0]);
    for(let i=1;i<rest.length;i++){
      const d=dist(last,rest[i]);
      if(d<best){ best=d; idx=i; }
    }
    ordered.push(rest[idx]);
    rest.splice(idx,1);
  }

  stops=ordered;
  activeIndex=0;
  localStorage.setItem("stops", JSON.stringify(stops));

  if(window.route) map.removeLayer(window.route);
  window.route=L.polyline(stops.map(s=>[s.lat,s.lon]),{color:"blue"}).addTo(map);
  map.fitBounds(window.route.getBounds());
  render();
};

function dist(a,b){
  const dx=(b.lon-a.lon)*Math.cos((a.lat+b.lat)/2*Math.PI/180);
  const dy=b.lat-a.lat;
  return Math.sqrt(dx*dx+dy*dy);
}

/* ---------- START ROUTE ---------- */
document.getElementById("startRoute").onclick = () => {
  if (!stops.length) return alert("No stops");
  moveToNext();
};

/* ---------- INIT ---------- */
render();
</script>
</body>
</html>