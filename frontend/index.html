<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>MM Courier Route Planner</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Places API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_API_KEY&libraries=places&callback=initAutocomplete"
    defer></script>

  <style>
    body {
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    #map {
      height: calc(100vh - 200px); /* leave space for bottom panel */
      width: 100%;
    }

    /* Sidebar styles */
    #sidebar {
      width: 300px;
      background: white;
      padding: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      height: calc(100vh - 200px);
      overflow-y: auto;
      position: fixed;
      left: 1rem;
      top: 1rem;
      z-index: 1500;
    }

    /* Bottom panel */
    #bottomControls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      padding: 1rem;
      box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    /* Google Places autocomplete dropdown */
    .pac-container {
      z-index: 2000 !important; /* always on top */
    }
  </style>
</head>

<body class="bg-gray-100 flex flex-col">

  <!-- Sidebar -->
  <div id="sidebar">
    <h2 class="text-lg font-bold mb-2 text-blue-800">üìç Stops</h2>
    <div id="stopList" class="space-y-3"></div>

    <div class="mt-4 border-t pt-4">
      <p class="text-sm font-semibold">Total Distance:</p>
      <p id="totalDistance" class="text-lg text-blue-700">‚Äî</p>

      <p class="text-sm font-semibold mt-2">Estimated Time:</p>
      <p id="totalTime" class="text-lg text-blue-700">‚Äî</p>
    </div>

    <button id="navBtn"
      class="mt-4 w-full bg-green-700 text-white py-2 rounded-lg text-center font-semibold">
      Start Navigation
    </button>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Bottom Controls -->
  <div id="bottomControls">
    <input id="newAddress" type="text" placeholder="Enter address"
      class="border px-3 py-2 rounded w-full mb-2" />

    <button id="addStop" class="w-full bg-blue-700 text-white py-2 rounded-lg mb-2 font-semibold">
      Add Stop
    </button>

    <button id="loadRoute" class="w-full bg-green-700 text-white py-2 rounded-lg font-semibold">
      Optimize Route
    </button>
  </div>

  <script>
    const API_URL = "https://mm-courier-route-planner.onrender.com";

    const map = L.map("map").setView([-26.2041, 28.0473], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    let stops = [];
    let markers = [];
    let routeLine = null;
    let autocomplete;
    let selectedPlace = null;

    function initAutocomplete() {
      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("newAddress"),
        { types: ["geocode"] }
      );

      autocomplete.addListener("place_changed", () => {
        selectedPlace = autocomplete.getPlace();
      });
    }

    // -------------------------
    // Add Stop
    // -------------------------
    document.getElementById("addStop").onclick = () => {
      if (!selectedPlace || !selectedPlace.geometry) {
        return alert("Please select a valid address from the suggestions.");
      }

      stops.push({
        lat: selectedPlace.geometry.location.lat(),
        lon: selectedPlace.geometry.location.lng(),
        name: selectedPlace.formatted_address
      });

      addMarker(selectedPlace.geometry.location.lat(), selectedPlace.geometry.location.lng());
      updateSidebar();

      document.getElementById("newAddress").value = "";
      selectedPlace = null;
    };

    function addMarker(lat, lon) {
      const marker = L.marker([lat, lon]).addTo(map);
      markers.push(marker);
    }

    // -------------------------
    // Sidebar Stop List
    // -------------------------
    function updateSidebar() {
      const list = document.getElementById("stopList");
      list.innerHTML = "";

      stops.forEach((s, index) => {
        const div = document.createElement("div");
        div.className = "p-2 border rounded flex justify-between items-center";

        div.innerHTML = `
          <span class="font-semibold">${index + 1}. ${s.name}</span>
          <button class="text-red-600 font-bold">X</button>
        `;

        // Zoom to marker
        div.onclick = () => map.setView([s.lat, s.lon], 14);

        // Delete stop
        div.querySelector("button").onclick = (e) => {
          e.stopPropagation();
          stops.splice(index, 1);
          map.removeLayer(markers[index]);
          markers.splice(index, 1);
          updateSidebar();
        };

        list.appendChild(div);
      });
    }

    // -------------------------
    // Load/Optimize Route
    // -------------------------
    document.getElementById("loadRoute").onclick = async () => {
      if (stops.length < 2) return alert("Add at least 2 stops.");

      try {
        const res = await fetch(`${API_URL}/optimize`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ stops })
        });

        const data = await res.json();
        if (!data.routes || !data.routes[0]) return alert("Route not found.");

        const route = data.routes[0];
        const coords = decodePolyline(route.overview_polyline.points);

        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(coords, { color: "blue" }).addTo(map);
        map.fitBounds(routeLine.getBounds());

        document.getElementById("totalDistance").innerText =
          (route.legs.reduce((a, b) => a + b.distance.value, 0) / 1000).toFixed(1) + " km";

        document.getElementById("totalTime").innerText =
          Math.round(route.legs.reduce((a, b) => a + b.duration.value, 0) / 60) + " mins";

      } catch (err) {
        console.error(err);
        alert("Failed to optimize route");
      }
    };

    // -------------------------
    // Start Navigation
    // -------------------------
    document.getElementById("navBtn").onclick = () => {
      if (stops.length < 2) return alert("Add stops first.");

      stops.forEach((s, i) => {
        addMarker(s.lat, s.lon);
      });

      map.fitBounds(markers.map(m => m.getLatLng()));
      alert("Navigation started! Use the map to follow your stops.");
    };

    // -------------------------
    // Polyline decoder
    // -------------------------
    function decodePolyline(str, precision = 5) {
      let index = 0, lat = 0, lng = 0, coordinates = [];
      const factor = Math.pow(10, precision);

      while (index < str.length) {
        let result = 0, shift = 0, byte;
        do {
          byte = str.charCodeAt(index++) - 63;
          result |= (byte & 0x1f) << shift;
          shift += 5;
        } while (byte >= 0x20);

        const dLat = (result & 1 ? ~(result >> 1) : (result >> 1));
        lat += dLat;

        result = 0; shift = 0;
        do {
          byte = str.charCodeAt(index++) - 63;
          result |= (byte & 0x1f) << shift;
          shift += 5;
        } while (byte >= 0x20);

        const dLng = (result & 1 ? ~(result >> 1) : (result >> 1));
        lng += dLng;

        coordinates.push([lat / factor, lng / factor]);
      }
      return coordinates;
    }
  </script>

</body>
</html>