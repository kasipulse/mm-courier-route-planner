<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MM Courier Route Planner</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2atTHVbN5tJkP6KycdxY6SY+4Z1p72XdTOxyPnk="
    crossorigin=""
  />

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    #map {
      height: 80vh;
      width: 100%;
    }

    #controls {
      padding: 10px;
    }

    textarea {
      width: 100%;
      height: 80px;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      background: #0a2b52;
      color: white;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
    }
  </style>
</head>

<body>

  <div id="controls">
    <h3>Enter Stops (one per line)</h3>
    <textarea id="stops"></textarea>
    <button onclick="loadRoute()">Load Route</button>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS (IMPORTANT: must load BEFORE your JS) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kGStGxmFjM3iC6low0Qo7NQYIY01JY1J8Jp0I="
    crossorigin=""
  ></script>

  <!-- Your Script -->
  <script>
    const API_BASE = "https://mm-courier-route-planner.onrender.com";

    // Initialize map
    const map = L.map("map").setView([-26.2041, 28.0473], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    let polyline = null;

    async function loadRoute() {
      const rawStops = document.getElementById("stops").value.trim().split("\n");

      if (rawStops.length < 2) {
        alert("Please enter at least 2 stops");
        return;
      }

      // Geocode each stop
      const geocoded = [];
      for (let address of rawStops) {
        let r = await fetch(API_BASE + "/geocode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address }),
        });
        geocoded.push(await r.json());
      }

      // Request optimized route
      let r = await fetch(API_BASE + "/optimize", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ stops: geocoded }),
      });
      let directions = await r.json();

      if (polyline) map.removeLayer(polyline);

      // Extract polyline coordinates
      const points = [];
      directions.routes[0].legs.forEach((leg) => {
        leg.steps.forEach((step) => {
          step.polyline.points.split("").forEach(() => {}); // ignore decode on server
        });
      });

      // decode overview polyline (easier)
      const decoded = decodePolyline(directions.routes[0].overview_polyline.points);

      polyline = L.polyline(decoded, { color: "blue", weight: 5 }).addTo(map);
      map.fitBounds(polyline.getBounds());
    }

    // Polyline decoder
    function decodePolyline(encoded) {
      let points = [];
      let index = 0, lat = 0, lng = 0;

      while (index < encoded.length) {
        let b, shift = 0, result = 0;
        do {
          b = encoded.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);
        let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
        lat += dlat;

        shift = 0;
        result = 0;
        do {
          b = encoded.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);
        let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
        lng += dlng;

        points.push([lat / 1e5, lng / 1e5]);
      }

      return points;
    }
  </script>

</body>
</html>
