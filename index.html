<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Route Planner (OSM + OSRM)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Tailwind (dev only) -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { margin:0; height:100vh; overflow:hidden; }
  #app { display:flex; flex-direction:column; height:100vh; }
  #map { flex:1; }
  #topbar { background:white; padding:0.5rem; z-index:600; }
  #controls { background:white; padding:0.75rem; border-top:1px solid #e5e7eb; z-index:600; }
  #navPanel {
    background:#0f172a; color:white;
    padding:0.75rem;
    display:none;
  }
</style>
</head>

<body>
<div id="app">

  <!-- Top bar -->
  <div id="topbar" class="shadow flex gap-2">
    <button id="optimizeBtn" class="bg-green-700 text-white px-4 py-2 rounded">
      Optimize Route
    </button>
    <button id="startNavBtn" class="bg-blue-700 text-white px-4 py-2 rounded">
      Start Route
    </button>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Navigation Panel -->
  <div id="navPanel">
    <div class="text-sm opacity-80">Next instruction</div>
    <div id="instruction" class="text-lg font-semibold">—</div>
    <div id="instructionDistance" class="text-sm mt-1 opacity-80">—</div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <input id="addressInput" type="text"
      placeholder="Enter address"
      class="border px-3 py-2 rounded w-full mb-2" />

    <ul id="suggestions"
      class="border rounded bg-white max-h-40 overflow-y-auto hidden mb-2"></ul>

    <button id="addStopBtn"
      class="w-full bg-gray-800 text-white py-2 rounded">
      Add Stop
    </button>
  </div>

</div>

<script>
/* ---------------- MAP ---------------- */
const map = L.map("map").setView([-26.2041, 28.0473], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let stops = [];
let markers = [];
let routeLine;
let instructions = [];
let currentStep = 0;

/* ---------------- AUTOCOMPLETE (Nominatim) ---------------- */
const input = document.getElementById("addressInput");
const suggestions = document.getElementById("suggestions");

input.addEventListener("input", async () => {
  const q = input.value.trim();
  if (q.length < 3) {
    suggestions.classList.add("hidden");
    return;
  }

  const res = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`
  );
  const data = await res.json();

  suggestions.innerHTML = "";
  data.forEach(item => {
    const li = document.createElement("li");
    li.className = "p-2 hover:bg-gray-100 cursor-pointer";
    li.textContent = item.display_name;
    li.onclick = () => {
      input.value = item.display_name;
      input.dataset.lat = item.lat;
      input.dataset.lon = item.lon;
      suggestions.classList.add("hidden");
    };
    suggestions.appendChild(li);
  });

  suggestions.classList.remove("hidden");
});

/* ---------------- ADD STOP ---------------- */
document.getElementById("addStopBtn").onclick = () => {
  if (!input.dataset.lat) {
    alert("Select address from list");
    return;
  }

  const lat = parseFloat(input.dataset.lat);
  const lon = parseFloat(input.dataset.lon);

  stops.push([lon, lat]); // OSRM uses lon,lat
  markers.push(L.marker([lat, lon]).addTo(map));

  map.setView([lat, lon], 14);

  input.value = "";
  delete input.dataset.lat;
  delete input.dataset.lon;
};

/* ---------------- OPTIMIZE ROUTE ---------------- */
document.getElementById("optimizeBtn").onclick = async () => {
  if (stops.length < 2) {
    alert("Add at least 2 stops");
    return;
  }

  const coords = stops.map(s => s.join(",")).join(";");

  // OSRM Trip API (optimization)
  const tripUrl = `https://router.project-osrm.org/trip/v1/driving/${coords}?source=first&roundtrip=false&overview=full&geometries=geojson&steps=true`;
  const res = await fetch(tripUrl);
  const data = await res.json();

  if (!data.trips) {
    alert("Route optimization failed");
    return;
  }

  const trip = data.trips[0];

  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.geoJSON(trip.geometry, { color: "blue" }).addTo(map);
  map.fitBounds(routeLine.getBounds());

  // Extract instructions
  instructions = [];
  trip.legs.forEach(leg => {
    leg.steps.forEach(step => {
      instructions.push({
        text: step.maneuver.instruction,
        distance: Math.round(step.distance)
      });
    });
  });

  alert("Route optimized. Start route to navigate.");
};

/* ---------------- START NAVIGATION ---------------- */
document.getElementById("startNavBtn").onclick = () => {
  if (!instructions.length) {
    alert("Optimize route first");
    return;
  }
  currentStep = 0;
  document.getElementById("navPanel").style.display = "block";
  showInstruction();
};

function showInstruction() {
  if (currentStep >= instructions.length) {
    document.getElementById("instruction").textContent = "Route complete";
    document.getElementById("instructionDistance").textContent = "";
    return;
  }

  const step = instructions[currentStep];
  document.getElementById("instruction").textContent = step.text;
  document.getElementById("instructionDistance").textContent =
    `In ${step.distance} meters`;

  // Auto-advance simulation (real GPS comes next)
  setTimeout(() => {
    currentStep++;
    showInstruction();
  }, 4000);
}
</script>
</body>
</html>