<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MM Route Planner</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Places -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPXDWN4D1063Yzml3zGjwb36ewDwzkVuk&libraries=places&callback=initAutocomplete"
    defer></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    #map {
      height: calc(100vh - 260px); /* space for panel */
      width: 100%;
      z-index: 1;
    }

    .pac-container {
      z-index: 9999 !important;
    }
  </style>
</head>

<body class="bg-gray-100 flex flex-col">

  <!-- MAP -->
  <div id="map"></div>

  <!-- CONTROL PANEL (ALWAYS VISIBLE) -->
  <div class="bg-white shadow-lg p-3 space-y-2 z-10">

    <!-- Address Input -->
    <input
      id="addressInput"
      type="text"
      placeholder="Enter delivery address"
      class="w-full border px-3 py-2 rounded"
    />

    <!-- Buttons -->
    <div class="flex gap-2">
      <button id="addStopBtn" class="flex-1 bg-blue-700 text-white py-2 rounded">
        Add Stop
      </button>
      <button id="optimizeBtn" class="flex-1 bg-green-700 text-white py-2 rounded">
        Load Route
      </button>
    </div>

    <!-- Stops List -->
    <div>
      <h3 class="font-bold text-sm mb-1">Stops</h3>
      <div id="stopsList" class="space-y-1 max-h-32 overflow-y-auto"></div>
    </div>

    <!-- Driver Controls -->
    <div class="flex gap-2">
      <button id="startRouteBtn" class="flex-1 bg-black text-white py-2 rounded">
        Start Route
      </button>
      <button id="deliveredBtn" class="flex-1 bg-green-600 text-white py-2 rounded">
        Delivered
      </button>
      <button id="nextStopBtn" class="flex-1 bg-orange-600 text-white py-2 rounded">
        Next Stop
      </button>
    </div>
  </div>

<script>
  const API_URL = "https://mm-courier-route-planner.onrender.com";

  let map = L.map("map").setView([-26.2041, 28.0473], 11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  let autocomplete;
  let stops = [];
  let markers = [];
  let routeLine;
  let currentIndex = 0;

  function initAutocomplete() {
    autocomplete = new google.maps.places.Autocomplete(
      document.getElementById("addressInput"),
      { types: ["geocode"] }
    );
  }

  document.getElementById("addStopBtn").onclick = () => {
    const place = autocomplete.getPlace();
    if (!place || !place.geometry) {
      alert("Select an address from suggestions");
      return;
    }

    const stop = {
      label: place.formatted_address,
      lat: place.geometry.location.lat(),
      lon: place.geometry.location.lng(),
      status: "pending"
    };

    stops.push(stop);

    const marker = L.marker([stop.lat, stop.lon]).addTo(map);
    markers.push(marker);

    document.getElementById("addressInput").value = "";
    renderStops();
  };

  function renderStops() {
    const list = document.getElementById("stopsList");
    list.innerHTML = "";

    stops.forEach((s, i) => {
      const div = document.createElement("div");
      div.className = "border p-2 rounded text-sm";
      div.innerHTML = `<strong>${i + 1}.</strong> ${s.label}`;
      div.onclick = () => map.setView([s.lat, s.lon], 14);
      list.appendChild(div);
    });
  }

  document.getElementById("optimizeBtn").onclick = async () => {
    if (stops.length < 2) {
      alert("Add at least 2 stops");
      return;
    }

    const res = await fetch(`${API_URL}/optimize`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ stops })
    });

    const data = await res.json();
    const route = data.routes?.[0];
    if (!route) return alert("No route found");

    const coords = decodePolyline(route.overview_polyline.points);

    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords, { color: "blue" }).addTo(map);
    map.fitBounds(routeLine.getBounds());
  };

  document.getElementById("startRouteBtn").onclick = () => {
    currentIndex = 0;
    navigateToCurrent();
  };

  document.getElementById("deliveredBtn").onclick = () => {
    if (!stops[currentIndex]) return;
    stops[currentIndex].status = "delivered";
    currentIndex++;
    navigateToCurrent();
  };

  document.getElementById("nextStopBtn").onclick = () => {
    currentIndex++;
    navigateToCurrent();
  };

  function navigateToCurrent() {
    if (currentIndex >= stops.length) {
      alert("Route complete");
      return;
    }

    const s = stops[currentIndex];
    const url = `https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lon}`;
    window.open(url, "_blank");
  }

  function decodePolyline(str) {
    let index = 0, lat = 0, lng = 0, coords = [];
    while (index < str.length) {
      let b, shift = 0, result = 0;
      do {
        b = str.charCodeAt(index++) - 63;
        result |= (b & 0x1f) << shift;
        shift += 5;
      } while (b >= 0x20);
      lat += (result & 1) ? ~(result >> 1) : (result >> 1);

      shift = 0; result = 0;
      do {
        b = str.charCodeAt(index++) - 63;
        result |= (b & 0x1f) << shift;
        shift += 5;
      } while (b >= 0x20);
      lng += (result & 1) ? ~(result >> 1) : (result >> 1);

      coords.push([lat / 1e5, lng / 1e5]);
    }
    return coords;
  }
</script>

</body>
</html>