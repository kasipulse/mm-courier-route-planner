<script>
const API_URL = "https://mm-courier-route-planner.onrender.com";
let map, stops = [], markers = [], routeLine = null, autocomplete;
let currentStopIndex = 0;

// -------------------------  
// Initialize Map & Resize
// -------------------------
function initMap() {
  map = L.map("map").setView([-26.2041, 28.0473], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  resizeMap();
  window.addEventListener("resize", resizeMap);

  // Mobile keyboard handling
  const bottomControls = document.getElementById("bottomControls");
  const newAddress = document.getElementById("newAddress");

  newAddress.addEventListener("focus", () => {
    setTimeout(() => {
      const kbHeight = 300; // approximate keyboard height
      document.getElementById("map").style.height = `calc(100vh - ${bottomControls.offsetHeight + kbHeight}px)`;
      map.invalidateSize();
      document.getElementById("sidebar").style.bottom = `${kbHeight}px`;
    }, 300);
  });

  newAddress.addEventListener("blur", () => {
    resizeMap();
    document.getElementById("sidebar").style.bottom = `0`;
  });
}

function resizeMap() {
  const bottomControls = document.getElementById("bottomControls");
  const bottomHeight = bottomControls.offsetHeight + 32;
  document.getElementById("map").style.height = `calc(100vh - ${bottomHeight}px)`;
  if (map) map.invalidateSize();
}

// -------------------------
// Google Places Autocomplete
// -------------------------
function initAutocomplete() {
  autocomplete = new google.maps.places.Autocomplete(
    document.getElementById("newAddress"),
    { types: ["geocode"] }
  );
}

// -------------------------
// Add Stop
// -------------------------
function addMarker(lat, lon) {
  const marker = L.marker([lat, lon]).addTo(map);
  markers.push(marker);
}

function updateSidebar() {
  const list = document.getElementById("stopList");
  list.innerHTML = "";
  stops.forEach((s, index) => {
    const div = document.createElement("div");
    div.className = "p-2 border rounded flex justify-between items-center";
    div.innerHTML = `<span class="font-semibold">Stop ${index + 1}</span><button class="text-red-600 font-bold">X</button>`;
    div.onclick = () => map.setView([s.lat, s.lon], 14);
    div.querySelector("button").onclick = (e) => {
      e.stopPropagation();
      stops.splice(index, 1);
      map.removeLayer(markers[index]);
      markers.splice(index, 1);
      updateSidebar();
    };
    list.appendChild(div);
  });
}

document.getElementById("addStop").onclick = () => {
  const place = autocomplete.getPlace();
  if (!place?.geometry) return alert("Select a valid address.");
  const lat = place.geometry.location.lat();
  const lon = place.geometry.location.lng();
  stops.push({ lat, lon });
  addMarker(lat, lon);
  updateSidebar();
  document.getElementById("newAddress").value = "";
};

// -------------------------
// Load Route
// -------------------------
document.getElementById("loadRoute").onclick = async () => {
  if (stops.length < 2) return alert("Add at least 2 stops.");
  const res = await fetch(`${API_URL}/optimize`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ stops }),
  });
  const data = await res.json();
  const route = data.routes?.[0];
  if (!route) return alert("Route not found.");

  const coords = decodePolyline(route.overview_polyline.points);
  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline(coords, { color: "blue" }).addTo(map);
  map.fitBounds(routeLine.getBounds());

  document.getElementById("totalDistance").innerText =
    route.legs.reduce((a, b) => a + b.distance.value, 0) / 1000 + " km";

  document.getElementById("totalTime").innerText =
    Math.round(route.legs.reduce((a, b) => a + b.duration.value, 0) / 60) + " mins";

  currentStopIndex = 0; // reset progress
};

// -------------------------
// Start Navigation from current GPS
// -------------------------
document.getElementById("navBtn").onclick = () => {
  if (!stops.length) return alert("Add at least 1 stop.");
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    navigateToCurrentStop(latitude, longitude);
  }, () => {
    const { lat, lon } = stops[currentStopIndex];
    navigateToCurrentStop(lat, lon);
  });
};

function navigateToCurrentStop(startLat, startLon) {
  if (currentStopIndex >= stops.length) return alert("All stops completed!");
  const destination = stops[currentStopIndex];
  const remaining = stops.slice(currentStopIndex + 1);
  const waypoints = remaining.map(s => `${s.lat},${s.lon}`).join("|");
  const url = `https://www.google.com/maps/dir/?api=1&origin=${startLat},${startLon}&destination=${destination.lat},${destination.lon}&waypoints=${waypoints}&travelmode=driving`;
  window.open(url, "_blank");
}

// -------------------------
// Mark Delivered & Next Stop
// -------------------------
document.getElementById("nextStopBtn").onclick = () => {
  if (currentStopIndex >= stops.length) return alert("All stops completed!");
  alert(`Stop ${currentStopIndex + 1} marked delivered!`);
  currentStopIndex++;
  if (currentStopIndex < stops.length) {
    const next = stops[currentStopIndex];
    map.setView([next.lat, next.lon], 15);
  } else alert("All stops completed!");
};

// -------------------------
// Sidebar toggle
// -------------------------
document.getElementById("toggleSidebar").onclick = () => {
  const sb = document.getElementById("sidebar");
  sb.classList.toggle("sidebar-visible");
  sb.classList.toggle("sidebar-hidden");
};

// -------------------------
// Polyline decode
// -------------------------
function decodePolyline(str, precision = 5) {
  let index = 0, lat = 0, lng = 0, coordinates = [];
  const factor = Math.pow(10, precision);
  while (index < str.length) {
    let result = 0, shift = 0, byte;
    do { byte = str.charCodeAt(index++) - 63; result |= (byte & 0x1f) << shift; shift += 5; } while (byte >= 0x20);
    const dLat = (result & 1 ? ~(result >> 1) : (result >> 1)); lat += dLat;
    result = 0; shift = 0;
    do { byte = str.charCodeAt(index++) - 63; result |= (byte & 0x1f) << shift; shift += 5; } while (byte >= 0x20);
    const dLng = (result & 1 ? ~(result >> 1) : (result >> 1)); lng += dLng;
    coordinates.push([lat / factor, lng / factor]);
  }
  return coordinates;
}

// -------------------------
// Init everything on DOM load
// -------------------------
document.addEventListener("DOMContentLoaded", () => {
  initMap();
});
</script>
