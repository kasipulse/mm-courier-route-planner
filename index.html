<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MM Courier Route Planner</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Places API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPXDWN4D1063Yzml3zGjwb36ewDwzkVuk&libraries=places&callback=initMap" async defer></script>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen">
<h1 class="text-2xl font-bold m-4 text-blue-800">ðŸšš MM Courier Route Planner</h1>

<div id="map" class="w-11/12 h-[70vh] rounded-2xl shadow-lg"></div>

<div class="mt-4 flex flex-wrap justify-center gap-2">
  <input id="addressInput" type="text" placeholder="Enter address" class="border px-2 py-1 rounded w-64"/>
  <button id="addStop" class="bg-green-600 text-white px-4 py-1 rounded">Add Stop</button>
  <button id="loadRoute" class="bg-blue-600 text-white px-4 py-1 rounded">Load Route</button>
</div>

<script>
const API_URL = "https://mm-courier-route-planner.onrender.com";
const map = L.map("map").setView([-26.2041, 28.0473], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap contributors"
}).addTo(map);

let stops = [
  { lat: -26.195246, lon: 28.034088 },
  { lat: -26.204103, lon: 28.047304 }
];

let markers = [];
let routeLine;

// Google Autocomplete
const autocomplete = new google.maps.places.Autocomplete(
  document.getElementById("addressInput"), { types: ["geocode"] }
);

function decodePolyline(str) {
  let index=0,lat=0,lng=0,coords=[],shift=0,result=0,byte=null,factor=1e-5;
  while(index<str.length){
    byte=null;shift=0;result=0;
    do{ byte=str.charCodeAt(index++)-63; result|=(byte&0x1f)<<shift; shift+=5 }while(byte>=0x20);
    let dlat=((result&1)?~(result>>1):(result>>1)); lat+=dlat;
    shift=0;result=0;
    do{ byte=str.charCodeAt(index++)-63; result|=(byte&0x1f)<<shift; shift+=5 }while(byte>=0x20);
    let dlng=((result&1)?~(result>>1):(result>>1)); lng+=dlng;
    coords.push([lat*factor,lng*factor]);
  }
  return coords;
}

async function loadRoute(){
  try {
    const res = await fetch(`${API_URL}/optimize`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ stops })
    });
    const data = await res.json();
    if(!data.routes) return alert("Failed to load route");

    const coords = decodePolyline(data.routes[0].overview_polyline.points);
    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords,{ color:"blue" }).addTo(map);

    markers.forEach(m=>map.removeLayer(m));
    markers=[];
    stops.forEach((s,i)=>{
      const marker=L.marker([s.lat,s.lon]).addTo(map);
      marker.bindPopup(`Stop ${i+1}`);
      markers.push(marker);
    });
    map.fitBounds(routeLine.getBounds());
  } catch(err){
    console.error(err);
    alert("Error optimizing route. Check console.");
  }
}

document.getElementById("loadRoute").addEventListener("click", loadRoute);

document.getElementById("addStop").addEventListener("click",()=>{
  const place=autocomplete.getPlace();
  if(!place||!place.geometry) return alert("Select a valid address from suggestions");

  stops.push({
    lat: place.geometry.location.lat(),
    lon: place.geometry.location.lng()
  });
  document.getElementById("addressInput").value="";
  loadRoute();
});

// Initial route
loadRoute();
</script>
</body>
</html>
