<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MM Courier Route Planner (OSM + Nominatim)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { flex:1; width:100%; height:100%; }
    #app { display:flex; height:100vh; flex-direction:column; }
    #controls { background:white; padding:1rem; border-top:1px solid #e5e7eb; position:relative; z-index:1000; }
    #sidebar {
      position:fixed; top:0; left:0; width:260px; height:100vh; background:white; 
      transform:translateX(-100%); transition: transform 0.3s ease; z-index:1500; overflow-y:auto;
      padding:1rem; box-shadow: 2px 0 6px rgba(0,0,0,0.2);
    }
    #sidebar.visible { transform:translateX(0); }
    #suggestions {
      position:absolute; top:3rem; left:0; right:0; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:2000;
    }
    .suggestion-item { padding:0.5rem; cursor:pointer; }
    .suggestion-item:hover { background:#e2e8f0; }
  </style>
</head>
<body>
<div id="app">

  <!-- Sidebar -->
  <div id="sidebar">
    <h2 class="text-lg font-bold mb-3">üìç Stops</h2>
    <div id="stopList" class="space-y-2"></div>

    <div class="mt-4 border-t pt-4">
      <p class="text-sm font-semibold">Distance</p>
      <p id="totalDistance">‚Äî</p>

      <p class="text-sm font-semibold mt-2">Time</p>
      <p id="totalTime">‚Äî</p>
    </div>

    <button id="navBtn" class="mt-6 w-full bg-green-700 text-white py-2 rounded">
      Start Navigation
    </button>
  </div>

  <!-- Top bar -->
  <div class="p-2 bg-white shadow flex">
    <button id="toggleSidebar" class="px-3 py-2 bg-gray-100 rounded font-semibold">
      ‚ò∞ Stops
    </button>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Bottom Controls -->
  <div id="controls">
    <input
      id="newAddress"
      type="text"
      placeholder="Enter address"
      class="border px-3 py-2 rounded w-full mb-2"
      autocomplete="off"
    />
    <div id="suggestions"></div>

    <button id="addStop" class="w-full bg-blue-700 text-white py-2 rounded mb-2">
      Add Stop
    </button>

    <button id="loadRoute" class="w-full bg-green-700 text-white py-2 rounded">
      Optimize Route
    </button>
  </div>

</div>

<script>
  const map = L.map("map").setView([-26.2041, 28.0473], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  let stops = [];
  let markers = [];

  const input = document.getElementById("newAddress");
  const suggestions = document.getElementById("suggestions");

  // ---------------------------
  // Sidebar toggle
  // ---------------------------
  document.getElementById("toggleSidebar").onclick = () => {
    document.getElementById("sidebar").classList.toggle("visible");
  };

  // ---------------------------
  // Fetch Nominatim suggestions
  // ---------------------------
  let debounceTimer;
  input.addEventListener("input", () => {
    const query = input.value.trim();
    if (query.length < 2) {
      suggestions.innerHTML = "";
      return;
    }

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      const res = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`
      );
      const data = await res.json();
      suggestions.innerHTML = "";
      data.forEach(place => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = place.display_name;
        div.onclick = () => {
          input.dataset.lat = place.lat;
          input.dataset.lon = place.lon;
          input.value = place.display_name;
          suggestions.innerHTML = "";
        };
        suggestions.appendChild(div);
      });
    }, 300);
  });

  // ---------------------------
  // Add Stop
  // ---------------------------
  document.getElementById("addStop").onclick = () => {
    const lat = input.dataset.lat;
    const lon = input.dataset.lon;

    if (!lat || !lon) {
      alert("Select an address from the suggestions");
      return;
    }

    stops.push({ lat, lon });
    markers.push(L.marker([lat, lon]).addTo(map));
    updateStops();

    input.value = "";
    delete input.dataset.lat;
    delete input.dataset.lon;
  };

  // ---------------------------
  // Update sidebar stop list
  // ---------------------------
  function updateStops() {
    const list = document.getElementById("stopList");
    list.innerHTML = "";

    stops.forEach((s, i) => {
      const div = document.createElement("div");
      div.className = "border p-2 rounded flex justify-between";
      div.innerHTML = `<span>Stop ${i + 1}</span><button>X</button>`;

      div.onclick = () => map.setView([s.lat, s.lon], 15);

      div.querySelector("button").onclick = (e) => {
        e.stopPropagation();
        map.removeLayer(markers[i]);
        markers.splice(i, 1);
        stops.splice(i, 1);
        updateStops();
      };

      list.appendChild(div);
    });
  }

  // ---------------------------
  // Load Route (placeholder)
  // ---------------------------
  document.getElementById("loadRoute").onclick = () => {
    if (stops.length < 2) { alert("Add at least 2 stops."); return; }
    alert("Route optimization will use OSRM / clustering logic (to implement)");
  };

  // ---------------------------
  // Navigation
  // ---------------------------
  document.getElementById("navBtn").onclick = () => {
    if (stops.length < 2) { alert("Add stops first."); return; }

    const origin = `${stops[0].lat},${stops[0].lon}`;
    const destination = `${stops[stops.length - 1].lat},${stops[stops.length - 1].lon}`;
    const waypoints = stops.slice(1, -1).map(s => `${s.lat},${s.lon}`).join("|");

    const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypoints}`;
    window.open(url, "_blank");
  };
</script>
</body>
</html>