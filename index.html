<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MM Courier Route Planner</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Places API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY&libraries=places&callback=initAutocomplete"
    defer></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      /* map height = full viewport minus bottom panel */
      height: calc(100vh - 150px);
      z-index: 0;
    }

    /* Sidebar */
    #sidebar {
      transition: transform 0.3s ease;
      z-index: 1500;
    }
    .sidebar-hidden { transform: translateX(-100%); }
    .sidebar-visible { transform: translateX(0); }

    /* Bottom panel */
    #bottomControls {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      max-width: 450px;
      background: white;
      padding: 1rem;
      border-radius: 0.5rem 0.5rem 0 0;
      box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
      z-index: 1200;
    }

    /* Google Places input */
    .pac-container { z-index: 2000 !important; }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <div id="sidebar" class="w-64 bg-white shadow-xl p-4 sidebar-hidden fixed h-screen overflow-y-auto">
    <h2 class="text-lg font-bold mb-2 text-blue-800">üìç Stops</h2>
    <div id="stopList" class="space-y-2"></div>

    <div class="mt-4 border-t pt-4">
      <p class="text-sm font-semibold">Total Distance:</p>
      <p id="totalDistance" class="text-lg text-blue-700">‚Äî</p>

      <p class="text-sm font-semibold mt-2">Estimated Time:</p>
      <p id="totalTime" class="text-lg text-blue-700">‚Äî</p>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Sidebar toggle -->
  <div class="absolute top-4 left-4 z-1600">
    <button id="toggleSidebar" class="bg-white shadow px-4 py-2 rounded-lg font-semibold">‚ò∞ Stops</button>
  </div>

  <!-- Bottom panel -->
  <div id="bottomControls">
    <input id="newAddress" type="text" placeholder="Enter address" class="border px-3 py-2 rounded w-full mb-2" />
    <button id="addStop" class="w-full bg-blue-700 text-white py-2 rounded-lg mb-2 font-semibold">Add Stop</button>
    <button id="loadRoute" class="w-full bg-green-700 text-white py-2 rounded-lg mb-2 font-semibold">Optimize Route</button>
    <button id="startRoute" class="w-full bg-indigo-700 text-white py-2 rounded-lg font-semibold">Start Route</button>

    <div id="navigationButtons" class="hidden mt-3 space-x-2">
      <button id="delivered" class="bg-green-600 text-white px-3 py-1 rounded">Delivered</button>
      <button id="notDelivered" class="bg-red-600 text-white px-3 py-1 rounded">Not Delivered</button>
      <button id="nextStop" class="bg-yellow-500 text-black px-3 py-1 rounded">Next Stop</button>
    </div>
  </div>

  <script>
    const API_URL = "https://mm-courier-route-planner.onrender.com";

    const map = L.map("map").setView([-26.2041, 28.0473], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    let stops = [];
    let markers = [];
    let routeLine = null;
    let currentStopIndex = 0;
    let autocomplete;

    function initAutocomplete() {
      autocomplete = new google.maps.places.Autocomplete(document.getElementById("newAddress"), { types: ["geocode"] });
    }

    // -------------------------
    // Sidebar toggle
    // -------------------------
    document.getElementById("toggleSidebar").onclick = () => {
      const sb = document.getElementById("sidebar");
      sb.classList.toggle("sidebar-visible");
      sb.classList.toggle("sidebar-hidden");
    };

    // -------------------------
    // Add Stop
    // -------------------------
    document.getElementById("addStop").onclick = () => {
      const place = autocomplete.getPlace();
      if (!place?.geometry) return alert("Select a valid address.");
      const lat = place.geometry.location.lat();
      const lon = place.geometry.location.lng();
      stops.push({ lat, lon, name: place.formatted_address });
      addMarker(lat, lon);
      updateSidebar();
      document.getElementById("newAddress").value = "";
    };

    function addMarker(lat, lon) {
      const marker = L.marker([lat, lon]).addTo(map);
      markers.push(marker);
    }

    // -------------------------
    // Update Sidebar
    // -------------------------
    function updateSidebar() {
      const list = document.getElementById("stopList");
      list.innerHTML = "";
      stops.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "p-2 border rounded flex justify-between items-center";
        div.innerHTML = `<span class="font-semibold">${s.name || 'Stop '+(i+1)}</span><button class="text-red-600 font-bold">X</button>`;
        div.querySelector("button").onclick = e => {
          e.stopPropagation();
          stops.splice(i,1);
          map.removeLayer(markers[i]);
          markers.splice(i,1);
          updateSidebar();
        };
        list.appendChild(div);
      });
    }

    // -------------------------
    // Optimize Route
    // -------------------------
    document.getElementById("loadRoute").onclick = async () => {
      if (stops.length < 2) return alert("Add at least 2 stops.");
      const res = await fetch(`${API_URL}/optimize`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({stops})
      });
      const data = await res.json();
      if (!data.routes || !data.routes[0]) return alert("No route returned.");
      const coords = decodePolyline(data.routes[0].overview_polyline.points);
      if (routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords, {color:"blue"}).addTo(map);
      map.fitBounds(routeLine.getBounds());
    };

    // -------------------------
    // Start Route
    // -------------------------
    document.getElementById("startRoute").onclick = () => {
      if (stops.length < 1) return alert("Add stops first.");
      currentStopIndex = 0;
      showNavigationButtons(true);
      goToCurrentStop();
    };

    function showNavigationButtons(show) {
      document.getElementById("navigationButtons").classList.toggle("hidden", !show);
    }

    function goToCurrentStop() {
      const stop = stops[currentStopIndex];
      if (!stop) return alert("No more stops.");
      map.setView([stop.lat, stop.lon], 16);
      markers[currentStopIndex].openPopup();
    }

    document.getElementById("nextStop").onclick = () => {
      if (currentStopIndex < stops.length-1) {
        currentStopIndex++;
        goToCurrentStop();
      } else alert("Route completed!");
    };

    document.getElementById("delivered").onclick = () => {
      alert(`Stop ${currentStopIndex+1} marked as Delivered`);
    };
    document.getElementById("notDelivered").onclick = () => {
      alert(`Stop ${currentStopIndex+1} marked as Not Delivered`);
    };

    // -------------------------
    // Polyline decoder
    // -------------------------
    function decodePolyline(str, precision = 5) {
      let index=0,lat=0,lng=0,coordinates=[];
      const factor = Math.pow(10, precision);
      while(index<str.length){
        let result=0,shift=0,byte;
        do { byte = str.charCodeAt(index++) - 63; result |= (byte & 0x1f)<<shift; shift+=5;} while(byte>=0x20);
        const dLat = (result & 1 ? ~(result>>1) : (result>>1)); lat+=dLat;
        result=0; shift=0;
        do { byte = str.charCodeAt(index++)-63; result|=(byte&0x1f)<<shift; shift+=5;} while(byte>=0x20);
        const dLng = (result&1 ? ~(result>>1) : (result>>1)); lng+=dLng;
        coordinates.push([lat/factor,lng/factor]);
      }
      return coordinates;
    }
  </script>

</body>
</html>