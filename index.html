<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>MM Courier Route Planner</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Places API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY&libraries=places&callback=initAutocomplete"
    defer></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      bottom: 0;
      z-index: 1;
    }

    /* Sidebar */
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 260px;
      height: 100%;
      background: white;
      z-index: 1000;
      box-shadow: 2px 0 6px rgba(0,0,0,0.3);
      padding: 1rem;
      overflow-y: auto;
    }

    /* Bottom controls panel */
    #bottomControls {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      z-index: 1001;
    }

    /* Google autocomplete dropdown */
    .pac-container {
      z-index: 2000 !important;
    }

    .stop-item {
      padding: 0.5rem;
      border: 1px solid #ddd;
      margin-bottom: 0.5rem;
      border-radius: 0.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
  </style>
</head>

<body>
  <!-- Sidebar for stops -->
  <div id="sidebar">
    <h2 class="text-lg font-bold mb-2 text-blue-800">üìç Stops</h2>
    <div id="stopList"></div>
    <div class="mt-4 border-t pt-4">
      <p class="text-sm font-semibold">Total Distance:</p>
      <p id="totalDistance" class="text-lg text-blue-700">‚Äî</p>
      <p class="text-sm font-semibold mt-2">Estimated Time:</p>
      <p id="totalTime" class="text-lg text-blue-700">‚Äî</p>
    </div>
    <button id="navBtn" class="mt-4 w-full bg-green-700 text-white py-2 rounded-lg font-semibold">
      Start Route
    </button>
    <div id="navigationControls" class="mt-4 hidden">
      <div class="nav-buttons">
        <button id="deliveredBtn" class="bg-blue-600 text-white py-1 px-2 rounded">Delivered</button>
        <button id="notDeliveredBtn" class="bg-red-600 text-white py-1 px-2 rounded">Not Delivered</button>
      </div>
      <button id="nextStopBtn" class="mt-2 w-full bg-yellow-600 text-white py-1 rounded">Next Stop</button>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Bottom controls -->
  <div id="bottomControls">
    <input id="newAddress" type="text" placeholder="Enter address"
      class="border px-3 py-2 rounded w-full mb-2" />
    <button id="addStop" class="w-full bg-blue-700 text-white py-2 rounded-lg mb-2 font-semibold">
      Add Stop
    </button>
    <button id="loadRoute" class="w-full bg-green-700 text-white py-2 rounded-lg font-semibold">
      Optimize Route
    </button>
  </div>

  <script>
    const API_URL = "http://localhost:3000"; // update if deployed
    const map = L.map("map").setView([-26.2041, 28.0473], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    let stops = [];
    let markers = [];
    let routeLine = null;
    let currentStopIndex = 0;
    let autocomplete;

    function initAutocomplete() {
      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("newAddress"),
        { types: ["geocode"] }
      );
    }

    // -------------------------
    // Add Stop
    // -------------------------
    document.getElementById('addStop').onclick = async () => {
      let place = autocomplete.getPlace();
      let lat, lon, address;

      if (place && place.geometry) {
        lat = place.geometry.location.lat();
        lon = place.geometry.location.lng();
        address = place.formatted_address;
      } else {
        const typedAddress = document.getElementById('newAddress').value.trim();
        if (!typedAddress) return alert("Enter an address");

        try {
          const res = await fetch(`${API_URL}/geocode`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: typedAddress })
          });
          const data = await res.json();
          if (data.error) return alert("Geocoding failed: " + data.error);
          lat = data.lat;
          lon = data.lng;
          address = typedAddress;
        } catch (err) {
          return alert("Error geocoding: " + err.message);
        }
      }

      stops.push({ lat, lon, address });
      addMarker(lat, lon, stops.length - 1);
      updateStopsDropdown();
      document.getElementById('newAddress').value = '';
    };

    function addMarker(lat, lon, index) {
      const marker = L.marker([lat, lon]).addTo(map)
        .bindPopup(`Stop ${index+1}: ${stops[index].address}`);
      markers.push(marker);
    }

    function updateStopsDropdown() {
      const list = document.getElementById('stopList');
      list.innerHTML = '';
      stops.forEach((stop, idx) => {
        const div = document.createElement('div');
        div.className = 'stop-item';
        div.innerHTML = `
          <span>${idx+1}. ${stop.address}</span>
          <button class="text-red-600 font-bold">X</button>
        `;
        div.onclick = () => map.setView([stop.lat, stop.lon], 14);
        div.querySelector('button').onclick = (e) => {
          e.stopPropagation();
          stops.splice(idx,1);
          map.removeLayer(markers[idx]);
          markers.splice(idx,1);
          updateStopsDropdown();
        };
        list.appendChild(div);
      });
    }

    // -------------------------
    // Optimize Route
    // -------------------------
    document.getElementById('loadRoute').onclick = async () => {
      if (stops.length < 2) return alert("Add at least 2 stops");
      try {
        const res = await fetch(`${API_URL}/optimize`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({stops})
        });
        const data = await res.json();
        const route = data.routes?.[0];
        if (!route) return alert("Route not found");

        const coords = decodePolyline(route.overview_polyline.points);
        if(routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(coords,{color:'blue'}).addTo(map);
        map.fitBounds(routeLine.getBounds());

        document.getElementById("totalDistance").innerText =
          (route.legs.reduce((a,b)=>a+b.distance.value,0)/1000).toFixed(1)+" km";
        document.getElementById("totalTime").innerText =
          Math.round(route.legs.reduce((a,b)=>a+b.duration.value,0)/60)+" mins";
      } catch(err){
        alert("Error optimizing route: "+err.message);
      }
    };

    // -------------------------
    // Start Route Navigation
    // -------------------------
    document.getElementById('navBtn').onclick = () => {
      if(stops.length<1) return alert("Add stops first");
      currentStopIndex = 0;
      document.getElementById('navigationControls').classList.remove('hidden');
      map.setView([stops[0].lat, stops[0].lon],14);
      markers[0].openPopup();
    };

    // -------------------------
    // Delivered / Not Delivered / Next Stop
    // -------------------------
    document.getElementById('deliveredBtn').onclick = () => {
      alert(`Stop ${currentStopIndex+1} marked as Delivered`);
    };
    document.getElementById('notDeliveredBtn').onclick = () => {
      alert(`Stop ${currentStopIndex+1} marked as Not Delivered`);
    };
    document.getElementById('nextStopBtn').onclick = () => {
      if(currentStopIndex+1 >= stops.length) return alert("All stops completed");
      currentStopIndex++;
      map.setView([stops[currentStopIndex].lat, stops[currentStopIndex].lon],14);
      markers[currentStopIndex].openPopup();
    };

    // -------------------------
    // Polyline decoder
    // -------------------------
    function decodePolyline(str, precision = 5) {
      let index=0,lat=0,lng=0,coordinates=[];
      const factor = Math.pow(10,precision);
      while(index<str.length){
        let result=0,shift=0,byte;
        do{ byte=str.charCodeAt(index++)-63; result|=(byte&0x1f)<<shift; shift+=5;}while(byte>=0x20);
        const dLat = (result &1 ? ~(result>>1) : result>>1); lat+=dLat;
        result=0; shift=0;
        do{ byte=str.charCodeAt(index++)-63; result|=(byte&0x1f)<<shift; shift+=5;}while(byte>=0x20);
        const dLng=(result&1?~(result>>1):result>>1); lng+=dLng;
        coordinates.push([lat/factor,lng/factor]);
      }
      return coordinates;
    }
  </script>
</body>
</html>