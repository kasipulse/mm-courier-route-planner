<script>
const API_URL = "https://mm-courier-route-planner.onrender.com";
const map = L.map("map").setView([-26.2041, 28.0473], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap contributors",
}).addTo(map);

let stops = [];
let routeLine;
let markers = [];

function decodePolyline(str, precision = 5) {
  let index = 0, lat = 0, lng = 0, coordinates = [], shift = 0, result = 0, byte = null;
  const factor = Math.pow(10, -precision);
  while (index < str.length) {
    byte = null; shift = 0; result = 0;
    do {
      byte = str.charCodeAt(index++) - 63;
      result |= (byte & 0x1f) << shift;
      shift += 5;
    } while (byte >= 0x20);
    let deltaLat = ((result & 1) ? ~(result >> 1) : (result >> 1));
    lat += deltaLat;
    shift = 0; result = 0;
    do {
      byte = str.charCodeAt(index++) - 63;
      result |= (byte & 0x1f) << shift;
      shift += 5;
    } while (byte >= 0x20);
    let deltaLng = ((result & 1) ? ~(result >> 1) : (result >> 1));
    lng += deltaLng;
    coordinates.push([lat * factor, lng * factor]);
  }
  return coordinates;
}

async function loadRoute() {
  if (stops.length < 2) {
    alert("Add at least 2 stops before loading the route.");
    return;
  }

  try {
    const res = await fetch(`${API_URL}/optimize`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ stops }),
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Server responded with ${res.status}: ${text}`);
    }

    const data = await res.json();

    if (!data.routes || !data.routes[0]) {
      alert("No route returned by the server.");
      console.error("Server response:", data);
      return;
    }

    const coords = decodePolyline(data.routes[0].overview_polyline.points);

    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords, { color: "blue" }).addTo(map);

    markers.forEach(m => map.removeLayer(m));
    markers = [];
    stops.forEach((s, i) => {
      const marker = L.marker([s.lat, s.lon]).addTo(map);
      marker.bindPopup(`Stop ${i + 1}`);
      markers.push(marker);
    });

    map.fitBounds(routeLine.getBounds());
  } catch (err) {
    console.error("Failed to load route:", err);
    alert(`Error loading route: ${err.message}`);
  }
}

document.getElementById("loadRoute").addEventListener("click", loadRoute);

document.getElementById("addStop").addEventListener("click", () => {
  const input = document.getElementById("newAddress");
  if (!input.value) return alert("Enter an address first.");

  // Placeholder: in future, convert address to lat/lon via Geocoding API
  const lat = -26.2 + Math.random() * 0.05;
  const lon = 28.0 + Math.random() * 0.05;
  stops.push({ lat, lon });
  input.value = "";
  alert("Stop added! Now click 'Load Route'.");
});
</script>
