<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
<title>MM Courier Mobile Route Planner</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Places API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPXDWN4D1063Yzml3zGjwb36ewDwzkVuk&libraries=places&callback=initAutocomplete" defer></script>

<style>
  body { margin:0; padding:0; overflow:hidden; -webkit-tap-highlight-color: transparent; }
  #map { height:100vh; width:100%; }
  #sidebar { transition: transform 0.3s ease; }
  .sidebar-hidden { transform: translateX(-100%); }
  .sidebar-visible { transform: translateX(0); }
</style>
</head>
<body class="bg-gray-100 flex overflow-hidden">

<!-- Sidebar -->
<div id="sidebar" class="w-64 bg-white shadow-xl p-4 sidebar-hidden fixed z-50 h-screen overflow-y-auto">
  <h2 class="text-lg font-bold mb-2 text-blue-800">üìç Stops</h2>
  <div id="stopList" class="space-y-3"></div>

  <div class="mt-4 border-t pt-4">
    <p class="text-sm font-semibold">Total Distance:</p>
    <p id="totalDistance" class="text-lg text-blue-700">‚Äî</p>

    <p class="text-sm font-semibold mt-2">Estimated Time:</p>
    <p id="totalTime" class="text-lg text-blue-700">‚Äî</p>
  </div>

  <button id="startRouteBtn" class="mt-4 w-full bg-green-700 text-white py-2 rounded-lg font-semibold">
    Start Route
  </button>

  <button id="nextStopBtn" class="mt-2 w-full bg-yellow-600 text-white py-2 rounded-lg font-semibold">
    Mark Delivered & Next Stop
  </button>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Top Controls -->
<div class="absolute top-4 left-4 z-50 flex gap-2">
  <button id="toggleSidebar" class="bg-white shadow px-4 py-2 rounded-lg font-semibold">‚ò∞ Stops</button>
</div>

<!-- Bottom Controls -->
<div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white shadow-xl p-4 rounded-lg w-11/12 max-w-lg flex flex-col gap-2">
  <input id="newAddress" type="text" placeholder="Enter address" class="border px-3 py-2 rounded w-full mb-2" />
  <button id="addStop" class="w-full bg-blue-700 text-white py-2 rounded-lg font-semibold">Add Stop</button>
  <button id="loadRoute" class="w-full bg-green-700 text-white py-2 rounded-lg font-semibold">Load Optimized Route</button>
</div>

<script>
const API_URL = "https://mm-courier-route-planner.onrender.com";

// Initialize map
const map = L.map("map").setView([-26.2041, 28.0473], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let stops = [];
let markers = [];
let routeLine = null;
let currentStopIndex = 0;
let autocomplete;

// Google Places Autocomplete callback
function initAutocomplete() {
  autocomplete = new google.maps.places.Autocomplete(document.getElementById("newAddress"), { types:["geocode"] });
}

// -------------------------
// Add Stop
// -------------------------
document.getElementById("addStop").onclick = () => {
  const place = autocomplete.getPlace();
  if (!place?.geometry) return alert("Select a valid address from suggestions.");

  const lat = place.geometry.location.lat();
  const lon = place.geometry.location.lng();
  stops.push({ lat, lon });
  addMarker(lat, lon);
  updateSidebar();
  document.getElementById("newAddress").value = "";
};

function addMarker(lat, lon) {
  const marker = L.marker([lat, lon]).addTo(map);
  markers.push(marker);
}

// -------------------------
// Sidebar
// -------------------------
function updateSidebar() {
  const list = document.getElementById("stopList");
  list.innerHTML = "";
  stops.forEach((s,index) => {
    const div = document.createElement("div");
    div.className = "p-2 border rounded flex justify-between items-center";
    div.innerHTML = `<span class="font-semibold">Stop ${index+1}</span><button class="text-red-600 font-bold">X</button>`;
    div.onclick = ()=>map.setView([s.lat, s.lon], 14);
    div.querySelector("button").onclick = (e)=>{
      e.stopPropagation();
      stops.splice(index,1);
      map.removeLayer(markers[index]);
      markers.splice(index,1);
      updateSidebar();
    };
    list.appendChild(div);
  });
}

// -------------------------
// Load Optimized Route
// -------------------------
document.getElementById("loadRoute").onclick = async () => {
  if (stops.length<2) return alert("Add at least 2 stops.");

  const res = await fetch(`${API_URL}/optimize`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({stops})
  });
  const data = await res.json();
  const route = data.routes?.[0];
  if(!route) return alert("Route not found.");

  const coords = decodePolyline(route.overview_polyline.points);
  if(routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline(coords,{color:"blue"}).addTo(map);
  map.fitBounds(routeLine.getBounds());

  document.getElementById("totalDistance").innerText = 
    (route.legs.reduce((a,b)=>a+b.distance.value,0)/1000).toFixed(1)+" km";
  document.getElementById("totalTime").innerText =
    Math.round(route.legs.reduce((a,b)=>a+b.duration.value,0)/60)+" mins";
  currentStopIndex = 0;
};

// -------------------------
// Start Route (from current GPS)
// -------------------------
document.getElementById("startRouteBtn").onclick = ()=>{
  if(!stops.length) return alert("Add at least 1 stop.");

  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    openGoogleNavigation(latitude,longitude);
  },err=>{
    alert("GPS unavailable, starting from first stop.");
    const {lat,lon} = stops[0];
    openGoogleNavigation(lat,lon);
  });
};

function openGoogleNavigation(startLat,startLon){
  if(currentStopIndex>=stops.length) return alert("No more stops.");
  const destination = stops[currentStopIndex];
  const remaining = stops.slice(currentStopIndex+1);
  const waypoints = remaining.map(s=>`${s.lat},${s.lon}`).join("|");
  const url = `https://www.google.com/maps/dir/?api=1&origin=${startLat},${startLon}&destination=${destination.lat},${destination.lon}&waypoints=${waypoints}&travelmode=driving`;
  window.open(url,"_blank");
}

// -------------------------
// Mark Delivered & Next Stop
// -------------------------
document.getElementById("nextStopBtn").onclick = ()=>{
  if(currentStopIndex>=stops.length) return alert("All stops completed.");
  alert(`Stop ${currentStopIndex+1} marked delivered!`);
  currentStopIndex++;
  if(currentStopIndex<stops.length){
    const next = stops[currentStopIndex];
    map.setView([next.lat,next.lon],15);
  } else alert("All stops completed!");
};

// -------------------------
// Sidebar toggle
// -------------------------
document.getElementById("toggleSidebar").onclick = ()=>{
  const sb=document.getElementById("sidebar");
  sb.classList.toggle("sidebar-visible");
  sb.classList.toggle("sidebar-hidden");
};

// -------------------------
// Decode Google polyline
// -------------------------
function decodePolyline(str, precision=5){
  let index=0,lat=0,lng=0,coords=[],factor=Math.pow(10,precision);
  while(index<str.length){
    let result=0,shift=0,byte;
    do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5;}while(byte>=0x20);
    const dLat=(result&1)?~(result>>1):(result>>1);lat+=dLat;
    result=0;shift=0;
    do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5;}while(byte>=0x20);
    const dLng=(result&1)?~(result>>1):(result>>1);lng+=dLng;
    coords.push([lat/factor,lng/factor]);
  }
  return coords;
}
</script>

</body>
</html>
