<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>MM Courier Route Planner</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Places API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_API_KEY&libraries=places&callback=initAutocomplete"
    defer></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    /* Map full height minus bottom panel */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 140px; /* leave space for bottom panel */
      z-index: 0;
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 0;
      left: -260px; /* hidden initially */
      width: 250px;
      height: 100%;
      background: white;
      box-shadow: 2px 0 6px rgba(0,0,0,0.1);
      padding: 1rem;
      overflow-y: auto;
      z-index: 1500;
      transition: left 0.3s ease;
    }

    #sidebar.visible {
      left: 0;
    }

    /* Bottom Controls */
    #bottomControls {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 1rem;
      border-radius: 0.5rem 0.5rem 0 0;
      box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      z-index: 1200;
    }

    /* Google Places autocomplete dropdown */
    .pac-container {
      z-index: 2000 !important;
    }

    /* Toggle button */
    #toggleSidebar {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1600;
      background: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div id="sidebar">
    <h2 class="text-lg font-bold mb-2 text-blue-800">üìç Stops</h2>
    <div id="stopList" class="space-y-3"></div>

    <div class="mt-4 border-t pt-4">
      <p class="text-sm font-semibold">Total Distance:</p>
      <p id="totalDistance" class="text-lg text-blue-700">‚Äî</p>

      <p class="text-sm font-semibold mt-2">Estimated Time:</p>
      <p id="totalTime" class="text-lg text-blue-700">‚Äî</p>
    </div>

    <button id="navBtn"
      class="mt-6 w-full bg-green-700 text-white py-2 rounded-lg text-center font-semibold">
      Start Navigation
    </button>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Sidebar toggle button -->
  <div id="toggleSidebar">‚ò∞ Stops</div>

  <!-- Bottom Controls -->
  <div id="bottomControls">
    <input id="newAddress" type="text" placeholder="Enter address"
      class="border px-3 py-2 rounded w-full mb-2" />

    <button id="addStop" class="w-full bg-blue-700 text-white py-2 rounded-lg mb-2 font-semibold">
      Add Stop
    </button>

    <button id="loadRoute" class="w-full bg-green-700 text-white py-2 rounded-lg font-semibold">
      Load Optimized Route
    </button>
  </div>

  <script>
    const API_URL = "https://mm-courier-route-planner.onrender.com";

    const map = L.map("map").setView([-26.2041, 28.0473], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    let stops = [];
    let markers = [];
    let routeLine = null;
    let autocomplete;

    // -------------------------
    // Google Autocomplete
    // -------------------------
    function initAutocomplete() {
      const input = document.getElementById("newAddress");
      autocomplete = new google.maps.places.Autocomplete(input, { types: ["geocode"] });
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") e.preventDefault();
      });
    }

    // -------------------------
    // Add Stop
    // -------------------------
    document.getElementById("addStop").onclick = async () => {
      const input = document.getElementById("newAddress");
      let place = autocomplete.getPlace();

      // Manual entry fallback
      if (!place || !place.geometry) {
        const address = input.value.trim();
        if (!address) return alert("Enter a valid address.");
        try {
          const res = await fetch(`${API_URL}/geocode`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ address }),
          });
          const data = await res.json();
          if (!data.lat || !data.lng) throw new Error("Invalid address");
          place = { geometry: { location: { lat: () => data.lat, lng: () => data.lng } } };
        } catch {
          return alert("Address not found");
        }
      }

      const lat = place.geometry.location.lat();
      const lon = place.geometry.location.lng();
      stops.push({ lat, lon });
      addMarker(lat, lon);
      updateSidebar();
      input.value = "";
    };

    function addMarker(lat, lon) {
      const marker = L.marker([lat, lon]).addTo(map);
      markers.push(marker);
    }

    // -------------------------
    // Sidebar Stop List
    // -------------------------
    function updateSidebar() {
      const list = document.getElementById("stopList");
      list.innerHTML = "";
      stops.forEach((s, index) => {
        const div = document.createElement("div");
        div.className = "p-2 border rounded flex justify-between items-center";
        div.innerHTML = `
          <span class="font-semibold">Stop ${index + 1}</span>
          <button class="text-red-600 font-bold">X</button>
        `;
        div.onclick = () => map.setView([s.lat, s.lon], 14);
        div.querySelector("button").onclick = (e) => {
          e.stopPropagation();
          stops.splice(index, 1);
          map.removeLayer(markers[index]);
          markers.splice(index, 1);
          updateSidebar();
        };
        list.appendChild(div);
      });
    }

    // -------------------------
    // Load Optimized Route
    // -------------------------
    document.getElementById("loadRoute").onclick = async () => {
      if (stops.length < 2) return alert("Add at least 2 stops.");
      const res = await fetch(`${API_URL}/optimize`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ stops }),
      });
      const data = await res.json();
      const route = data.routes?.[0];
      if (!route) return alert("Route not found.");

      const coords = decodePolyline(route.overview_polyline.points);
      if (routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords, { color: "blue" }).addTo(map);
      map.fitBounds(routeLine.getBounds());

      document.getElementById("totalDistance").innerText =
        (route.legs.reduce((a,b)=>a+b.distance.value,0)/1000).toFixed(1) + " km";
      document.getElementById("totalTime").innerText =
        Math.round(route.legs.reduce((a,b)=>a+b.duration.value,0)/60) + " mins";
    };

    // -------------------------
    // Navigation
    // -------------------------
    document.getElementById("navBtn").onclick = () => {
      if (stops.length < 2) return alert("Add stops first.");
      const origin = `${stops[0].lat},${stops[0].lon}`;
      const destination = `${stops[stops.length-1].lat},${stops[stops.length-1].lon}`;
      const waypoints = stops.slice(1,-1).map(s=>`${s.lat},${s.lon}`).join("|");
      const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypoints}`;
      window.open(url, "_blank");
    };

    // -------------------------
    // Sidebar Toggle
    // -------------------------
    document.getElementById("toggleSidebar").onclick = () => {
      const sidebar = document.getElementById("sidebar");
      sidebar.classList.toggle("visible");
    };

    // -------------------------
    // Polyline decoder
    // -------------------------
    function decodePolyline(str, precision = 5) {
      let index = 0, lat = 0, lng = 0, coordinates = [];
      const factor = Math.pow(10, precision);

      while (index < str.length) {
        let result = 0, shift = 0, byte;
        do {
          byte = str.charCodeAt(index++) - 63;
          result |= (byte & 0x1f) << shift;
          shift += 5;
        } while (byte >= 0x20);
        const dLat = (result & 1 ? ~(result >> 1) : (result >> 1));
        lat += dLat;

        result = 0; shift = 0;
        do {
          byte = str.charCodeAt(index++) - 63;
          result |= (byte & 0x1f) << shift;
          shift += 5;
        } while (byte >= 0x20);
        const dLng = (result & 1 ? ~(result >> 1) : (result >> 1));
        lng += dLng;

        coordinates.push([lat/factor, lng/factor]);
      }
      return coordinates;
    }
  </script>
</body>
</html>
